<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Constituency Map</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link rel="stylesheet" href="/static/core/site.css" />
    <style>
      #map {
        height: 70vh;
        border-radius: 12px;
        background: #f8fafc;
      }
      .map-legend {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
        padding: 12px 14px;
        font-size: 14px;
        line-height: 1.4;
        max-height: 55vh;
        overflow: auto;
      }
      .map-legend h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        color: #475569;
      }
      .map-legend .legend-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
      }
      .map-legend .legend-row:last-child {
        margin-bottom: 0;
      }
      .map-legend .swatch {
        width: 14px;
        height: 14px;
        border-radius: 4px;
        border: 1px solid rgba(15, 23, 42, 0.15);
      }
    </style>
  </head>
  <body>
    <main class="container">
      <div class="topbar">
        <div class="lang">
          <a class="link" href="/set-lang/en/?next={{ request.get_full_path|urlencode }}">English</a>
          <span> | </span>
          <a class="link" href="/set-lang/ta/?next={{ request.get_full_path|urlencode }}">தமிழ்</a>
        </div>
      </div>
      {% if data_vintage_label %}
      <div class="banner">{{ data_vintage_label }}</div>
      {% endif %}
      <a class="link" href="/">← {% if current_language == "ta" %}முகப்பு{% else %}Back to home{% endif %}</a>
      <h1>{% if current_language == "ta" %}தொகுதி வரைபடம்{% else %}Interactive Constituency Map{% endif %}</h1>
      <div id="map"></div>
    </main>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      const map = L.map("map", {
        zoomControl: true,
        attributionControl: false,
      }).setView([10.9, 78.7], 7);

      fetch("/map/data/")
        .then((response) => response.json())
        .then((data) => {
          const geoJsonLayer = L.geoJSON(data, {
            style: (feature) => {
              const partyColor = feature.properties.party_color;
              const isVacant = feature.properties.vacant;
              const isUnknown = feature.properties.unknown;
              return {
                color: "#94a3b8",
                weight: 1,
                fillColor: partyColor || (isVacant ? "#CBD5F5" : "#E2E8F0"),
                fillOpacity: isUnknown ? 0 : 0.9,
              };
            },
            onEachFeature: (feature, layer) => {
              const { id, name, district } = feature.properties;
              const tooltip = `<strong>${name}</strong><br /><span>${district}</span>`;
              layer.bindTooltip(tooltip, {
                direction: "top",
                sticky: true,
                className: "constituency-tooltip",
              });
              layer.on({
                mouseover: (event) => {
                  event.target.setStyle({
                    weight: 2,
                    color: "#0f172a",
                    fillOpacity: feature.properties.unknown ? 0.1 : 0.95,
                  });
                },
                mouseout: (event) => {
                  geoJsonLayer.resetStyle(event.target);
                },
                click: () => {
                  window.location.href = `/constituency/${id}/`;
                },
              });
            },
          }).addTo(map);
          if (geoJsonLayer.getBounds().isValid()) {
            map.fitBounds(geoJsonLayer.getBounds(), { padding: [12, 12] });
            map.setMaxBounds(geoJsonLayer.getBounds());
            map.options.maxBoundsViscosity = 1.0;
          }

          if (Array.isArray(data.legend) && data.legend.length) {
            const legendControl = L.control({ position: "topright" });
            legendControl.onAdd = () => {
              const div = L.DomUtil.create("div", "map-legend");
              div.innerHTML = `<h3>Legend</h3>`;
              const fragment = document.createDocumentFragment();
              data.legend.forEach((item) => {
                const row = document.createElement("div");
                row.className = "legend-row";
                row.innerHTML = `<span class="swatch" style="background:${item.color}"></span>${item.party}`;
                fragment.appendChild(row);
              });
              const vacantRow = document.createElement("div");
              vacantRow.className = "legend-row";
              vacantRow.innerHTML = `<span class="swatch" style="background:#CBD5F5"></span>Vacant`;
              fragment.appendChild(vacantRow);
              div.appendChild(fragment);
              return div;
            };
            legendControl.addTo(map);
          }
        });
    </script>
  </body>
</html>
