<!DOCTYPE html>
<html lang="en">
  {% load indian_numbers %}
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Party Dashboard</title>
    <link rel="stylesheet" href="/static/core/site.css" />
  </head>
  <body>
    <main class="container">
      <div class="topbar">
        <div class="lang">
          <a class="link" href="/set-lang/en/?next={{ request.get_full_path|urlencode }}">English</a>
          <span> | </span>
          <a class="link" href="/set-lang/ta/?next={{ request.get_full_path|urlencode }}">தமிழ்</a>
        </div>
      </div>
      {% if data_vintage_label %}
      <div class="banner">{{ data_vintage_label }}</div>
      {% endif %}
      <a class="link" href="/">← {% if current_language == "ta" %}முகப்பு{% else %}Back to home{% endif %}</a>
      <h1>{% if current_language == "ta" %}கட்சி காட்சிப்பலகை{% else %}Party Dashboard{% endif %}</h1>
      <p class="muted">
        {% if current_language == "ta" %}
          CSV தரவின் அடிப்படையில் கட்சிப் படிநிலைகள் மற்றும் சராசரிகள்.
        {% else %}
          Party-level aggregates based on the candidate CSV data.
        {% endif %}
      </p>

      <section class="card">
        <h2>{% if current_language == "ta" %}மேலோட்டம்{% else %}Overview{% endif %}</h2>
        <dl class="grid">
          <div>
            <dt>{% if current_language == "ta" %}மொத்த கட்சிகள்{% else %}Total parties{% endif %}</dt>
            <dd>{{ total_parties|indian }}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}மொத்த வேட்பாளர்கள்{% else %}Total candidates{% endif %}</dt>
            <dd>{{ total_candidates|indian }}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}சராசரி குற்ற வழக்குகள்{% else %}Avg. criminal cases{% endif %}</dt>
            <dd>{% if overall_avg_cases is not None %}{{ overall_avg_cases|indian }}{% else %}—{% endif %}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}சராசரி வயது{% else %}Avg. age{% endif %}</dt>
            <dd>{% if overall_avg_age is not None %}{{ overall_avg_age|indian }}{% else %}—{% endif %}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}சராசரி சொத்து (₹){% else %}Avg. assets (₹){% endif %}</dt>
            <dd>{% if overall_avg_assets is not None %}₹ {{ overall_avg_assets|indian }}{% else %}—{% endif %}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}சராசரி கடன்கள் (₹){% else %}Avg. liabilities (₹){% endif %}</dt>
            <dd>{% if overall_avg_liabilities is not None %}₹ {{ overall_avg_liabilities|indian }}{% else %}—{% endif %}</dd>
          </div>
        </dl>
      </section>

      <section class="card">
        <h2>{% if current_language == "ta" %}வடிகட்டிகள்{% else %}Filters{% endif %}</h2>
        <form class="filters" method="get">
          <label>
            {% if current_language == "ta" %}ஆண்டு{% else %}Year{% endif %}
            <select name="year">
              <option value="2021" {% if year == "2021" %}selected{% endif %}>2021</option>
              <option value="2026" {% if year == "2026" %}selected{% endif %}>2026</option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}குற்ற வழக்குகள்{% else %}Criminal cases{% endif %}
            <div class="range-wrap">
              <div class="range-pair">
                <input
                  type="range"
                  name="min_cases"
                  min="{{ cases_bounds.0 }}"
                  max="{{ cases_bounds.1 }}"
                  value="{{ min_cases }}"
                  step="1"
                />
                <input
                  type="range"
                  name="max_cases"
                  min="{{ cases_bounds.0 }}"
                  max="{{ cases_bounds.1 }}"
                  value="{{ max_cases|default:cases_bounds.1 }}"
                  step="1"
                />
              </div>
              <div class="range-values">
                <output class="min-value">{{ min_cases|indian }}</output>
                <span>–</span>
                <output class="max-value">{{ max_cases|default:cases_bounds.1|indian }}</output>
              </div>
            </div>
          </label>
          <label>
            {% if current_language == "ta" %}வயது{% else %}Age{% endif %}
            <div class="range-wrap">
              <div class="range-pair">
                <input
                  type="range"
                  name="min_age"
                  min="{{ age_bounds.0 }}"
                  max="{{ age_bounds.1 }}"
                  value="{{ min_age }}"
                  step="1"
                />
                <input
                  type="range"
                  name="max_age"
                  min="{{ age_bounds.0 }}"
                  max="{{ age_bounds.1 }}"
                  value="{{ max_age }}"
                  step="1"
                />
              </div>
              <div class="range-values">
                <output class="min-value">{{ min_age|indian }}</output>
                <span>–</span>
                <output class="max-value">{{ max_age|indian }}</output>
              </div>
            </div>
          </label>
          <label>
            {% if current_language == "ta" %}சொத்துகள் (₹){% else %}Assets (₹){% endif %}
            <div class="range-wrap">
              <div class="range-pair">
                <input
                  type="range"
                  name="min_assets"
                  min="{{ assets_bounds.0 }}"
                  max="{{ assets_bounds.1 }}"
                  value="{{ min_assets }}"
                  step="1"
                />
                <input
                  type="range"
                  name="max_assets"
                  min="{{ assets_bounds.0 }}"
                  max="{{ assets_bounds.1 }}"
                  value="{{ max_assets }}"
                  step="1"
                />
              </div>
              <div class="range-values">
                <output class="min-value">{{ min_assets|indian }}</output>
                <span>–</span>
                <output class="max-value">{{ max_assets|indian }}</output>
              </div>
            </div>
          </label>
          <label>
            {% if current_language == "ta" %}பாக்கிகள் (₹){% else %}Liabilities (₹){% endif %}
            <div class="range-wrap">
              <div class="range-pair">
                <input
                  type="range"
                  name="min_liabilities"
                  min="{{ liabilities_bounds.0 }}"
                  max="{{ liabilities_bounds.1 }}"
                  value="{{ min_liabilities }}"
                  step="1"
                />
                <input
                  type="range"
                  name="max_liabilities"
                  min="{{ liabilities_bounds.0 }}"
                  max="{{ liabilities_bounds.1 }}"
                  value="{{ max_liabilities }}"
                  step="1"
                />
              </div>
              <div class="range-values">
                <output class="min-value">{{ min_liabilities|indian }}</output>
                <span>–</span>
                <output class="max-value">{{ max_liabilities|indian }}</output>
              </div>
            </div>
          </label>
          <label>
            {% if current_language == "ta" %}தற்போதைய எம்.எல்.ஏ{% else %}Sitting MLA{% endif %}
            <select name="sitting_mla">
              <option value="" {% if not sitting_mla %}selected{% endif %}>
                {% if current_language == "ta" %}எல்லாம்{% else %}All{% endif %}
              </option>
              <option value="1" {% if sitting_mla == "1" %}selected{% endif %}>
                {% if current_language == "ta" %}ஆம்{% else %}Only sitting{% endif %}
              </option>
              <option value="0" {% if sitting_mla == "0" %}selected{% endif %}>
                {% if current_language == "ta" %}இல்லை{% else %}Exclude sitting{% endif %}
              </option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}கட்சிகள்{% else %}Parties{% endif %}
            <select name="party">
              <option value="" {% if not selected_party %}selected{% endif %}>
                {% if current_language == "ta" %}அனைத்தும்{% else %}All parties{% endif %}
              </option>
              {% for party in all_parties %}
                <option value="{{ party }}" {% if party == selected_party %}selected{% endif %}>{{ party }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}மாவட்டம்{% else %}District{% endif %}
            <select name="district">
              <option value="" {% if not selected_district %}selected{% endif %}>
                {% if current_language == "ta" %}அனைத்தும்{% else %}All districts{% endif %}
              </option>
              {% for district in districts %}
                <option value="{{ district }}" {% if district == selected_district %}selected{% endif %}>{{ district }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}தொகுதி{% else %}Constituency{% endif %}
            <select name="constituency">
              <option value="" {% if not selected_constituency %}selected{% endif %}>
                {% if current_language == "ta" %}அனைத்தும்{% else %}All constituencies{% endif %}
              </option>
              {% for constituency in constituencies %}
                <option value="{{ constituency }}" {% if constituency == selected_constituency %}selected{% endif %}>{{ constituency }}</option>
              {% endfor %}
            </select>
          </label>
          <button type="submit" class="button">
            {% if current_language == "ta" %}பயன் காட்ட{% else %}Apply{% endif %}
          </button>
        </form>
        <p class="muted">
          {% if current_language == "ta" %}
            வடிகட்டிகளுக்குப் பிறகு: {{ rows_count|indian }} வேட்பாளர் பதிவுகள்.
          {% else %}
            After filters: {{ rows_count|indian }} candidate rows.
          {% endif %}
        </p>
      </section>

      <section class="card">
        <h2>{% if current_language == "ta" %}கட்சிகள் ஒரு பார்வை{% else %}Party snapshot{% endif %}</h2>
        {% if party_stats %}
        <table class="table">
          <thead>
            <tr>
              <th>
                <a class="link" href="?{{ base_query }}&sort=party&order={% if sort_key == 'party' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                  {% if current_language == "ta" %}கட்சி{% else %}Party{% endif %}
                </a>
              </th>
              <th>
                <a class="link" href="?{{ base_query }}&sort=candidate_count&order={% if sort_key == 'candidate_count' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                  {% if current_language == "ta" %}வேட்பாளர் எண்ணிக்கை{% else %}Candidates{% endif %}
                </a>
              </th>
              <th>
                <a class="link" href="?{{ base_query }}&sort=avg_cases&order={% if sort_key == 'avg_cases' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                  {% if current_language == "ta" %}சராசரி குற்ற வழக்குகள்{% else %}Avg. cases{% endif %}
                </a>
              </th>
              <th>
                <a class="link" href="?{{ base_query }}&sort=cases_pct&order={% if sort_key == 'cases_pct' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                  {% if current_language == "ta" %}குற்ற வழக்குகள் உள்ளவர்களின் விகிதம்{% else %}% with cases{% endif %}
                </a>
              </th>
              <th>
                <a class="link" href="?{{ base_query }}&sort=avg_age&order={% if sort_key == 'avg_age' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                  {% if current_language == "ta" %}சராசரி வயது{% else %}Avg. age{% endif %}
                </a>
              </th>
              <th>
                <a class="link" href="?{{ base_query }}&sort=avg_assets&order={% if sort_key == 'avg_assets' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                  {% if current_language == "ta" %}சராசரி சொத்து (₹){% else %}Avg. assets (₹){% endif %}
                </a>
              </th>
              <th>
                <a class="link" href="?{{ base_query }}&sort=avg_liabilities&order={% if sort_key == 'avg_liabilities' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                  {% if current_language == "ta" %}சராசரி கடன்கள் (₹){% else %}Avg. liabilities (₹){% endif %}
                </a>
              </th>
              <th>
                <a class="link" href="?{{ base_query }}&sort=sitting_pct&order={% if sort_key == 'sitting_pct' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                  {% if current_language == "ta" %}தற்போதைய எம்.எல்.ஏ விகிதம்{% else %}% sitting MLA{% endif %}
                </a>
              </th>
              <th>
                <a class="link" href="?{{ base_query }}&sort=top_education&order={% if sort_key == 'top_education' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                  {% if current_language == "ta" %}அதிகம் காணப்படும் கல்வி{% else %}Top education{% endif %}
                </a>
              </th>
            </tr>
          </thead>
          <tbody>
            {% for party in party_stats %}
            <tr>
              <td>
                <a class="link" href="/party/{{ party.party|urlencode }}/?year={{ year }}">
                  {{ party.party }}
                </a>
              </td>
              <td>{{ party.candidate_count|indian }}</td>
              <td>{% if party.avg_cases is not None %}{{ party.avg_cases|indian }}{% else %}—{% endif %}</td>
              <td>{{ party.cases_pct|indian }}%</td>
              <td>{% if party.avg_age is not None %}{{ party.avg_age|indian }}{% else %}—{% endif %}</td>
              <td>{% if party.avg_assets is not None %}₹ {{ party.avg_assets|indian }}{% else %}—{% endif %}</td>
              <td>{% if party.avg_liabilities is not None %}₹ {{ party.avg_liabilities|indian }}{% else %}—{% endif %}</td>
              <td>{{ party.sitting_pct|indian }}%</td>
              <td>{% if party.top_education %}{{ party.top_education }}{% else %}—{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="muted">
          {% if current_language == "ta" %}
            CSV தரவுகள் கிடைக்கவில்லை.
          {% else %}
            No CSV data found.
          {% endif %}
        </p>
        {% endif %}
      </section>
    </main>
    <script>
      document.querySelectorAll(".range-wrap").forEach((wrap) => {
        const [minInput, maxInput] = wrap.querySelectorAll("input[type='range']");
        const minOutput = wrap.querySelector(".min-value");
        const maxOutput = wrap.querySelector(".max-value");

        const format = (value) => Number(value).toLocaleString("en-IN");
        const sync = () => {
          const minValue = Math.min(Number(minInput.value), Number(maxInput.value));
          const maxValue = Math.max(Number(minInput.value), Number(maxInput.value));
          minInput.value = minValue;
          maxInput.value = maxValue;
          minOutput.textContent = format(minValue);
          maxOutput.textContent = format(maxValue);
        };

        minInput.addEventListener("input", sync);
        maxInput.addEventListener("input", sync);
        sync();
      });
    </script>
  </body>
</html>
