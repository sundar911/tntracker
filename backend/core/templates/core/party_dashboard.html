<!DOCTYPE html>
<html lang="en">
  {% load indian_numbers %}
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Party Dashboard</title>
    <meta property="og:title" content="Tamil Nadu Assembly Elections 2026" />
    <meta property="og:description" content="Know your candidates and political parties, clearly and confidently. Explore financial and legal backgrounds of ~4000 candidates across 234 constituencies." />
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}/static/core/logo.png" />
    <meta property="og:type" content="website" />
    <meta name="description" content="Know your candidates and political parties, clearly and confidently. Explore financial and legal backgrounds of ~4000 candidates across 234 constituencies." />
    <link rel="stylesheet" href="/static/core/site.css" />
  </head>
  <body>
    <header class="site-header compact">
      <div class="container nav">
        <a class="brand-link" href="/">
          <div class="brand">
            <img class="brand-logo" src="/static/core/logo.png" alt="Tamil Nadu Election Tracker" />
            <div class="brand-text">
              <div class="brand-title">
                {% if current_language == "ta" %}தமிழ்நாடு தேர்தல் கண்காணிப்பான்{% else %}Tamil Nadu Election Tracker{% endif %}
              </div>
              <div class="brand-subtitle">
                {% if current_language == "ta" %}2026 சட்டமன்றத் தேர்தல்{% else %}Assembly Elections 2026{% endif %}
              </div>
            </div>
          </div>
        </a>
        <div class="nav-links">
          <a class="nav-link" href="/map/">{% if current_language == "ta" %}வரைபடம்{% else %}Maps{% endif %}</a>
          <a class="nav-link nav-link-active" href="/party-dashboard/"><span class="nav-full">{% if current_language == "ta" %}வேட்பாளர்களை அறியவும்{% else %}Know your Candidates{% endif %}</span><span class="nav-short">{% if current_language == "ta" %}வேட்பாளர்கள்{% else %}Candidates{% endif %}</span></a>
          <a class="nav-link" href="/resources/">{% if current_language == "ta" %}வளங்கள்{% else %}Resources{% endif %}</a>
        </div>
        <div class="nav-actions">
          <div class="lang-switch">
            <a class="{% if current_language == 'en' %}lang-active{% endif %}" href="/set-lang/en/?next={{ request.get_full_path|urlencode }}">English</a>
            <span class="lang-sep">•</span>
            <a class="{% if current_language == 'ta' %}lang-active{% endif %}" href="/set-lang/ta/?next={{ request.get_full_path|urlencode }}">தமிழ்</a>
          </div>
        </div>
      </div>
    </header>
    <main class="container">
      {% if data_vintage_label %}
      <div class="banner" style="margin-top: 8px;">
        {% if current_language == "ta" %}
          அதிகாரப்பூர்வ 2021 முடிவுகள். 2026 வேட்புமனு விரைவில்.
        {% else %}
          {{ data_vintage_label }}
        {% endif %}
      </div>
      {% endif %}
      <h1>{% if current_language == "ta" %}கட்சி காட்சிப்பலகை{% else %}Party Dashboard{% endif %}</h1>

      <section class="card">
        <dl class="overview-tiles">
          <div>
            <dt>{% if current_language == "ta" %}மொத்த கட்சிகள்{% else %}Total parties{% endif %}</dt>
            <dd>{{ total_parties|indian }}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}மொத்த வேட்பாளர்கள்{% else %}Total candidates{% endif %}</dt>
            <dd>{{ total_candidates|indian }}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}சராசரி குற்ற வழக்குகள்{% else %}Avg. criminal cases{% endif %}</dt>
            <dd>{% if overall_avg_cases is not None %}{{ overall_avg_cases|indian }}{% else %}—{% endif %}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}சராசரி வயது{% else %}Avg. age{% endif %}</dt>
            <dd>{% if overall_avg_age is not None %}{{ overall_avg_age|indian }}{% else %}—{% endif %}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}சராசரி சொத்து (₹){% else %}Avg. assets (₹){% endif %}</dt>
            <dd>{% if overall_avg_assets is not None %}<span title="₹ {{ overall_avg_assets|indian }}">₹ {{ overall_avg_assets|short_indian }}</span>{% else %}—{% endif %}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}சராசரி கடன்கள் (₹){% else %}Avg. liabilities (₹){% endif %}</dt>
            <dd>{% if overall_avg_liabilities is not None %}<span title="₹ {{ overall_avg_liabilities|indian }}">₹ {{ overall_avg_liabilities|short_indian }}</span>{% else %}—{% endif %}</dd>
          </div>
        </dl>
      </section>

      <!-- Mobile filter trigger (hidden on desktop via CSS) -->
      <button class="filter-trigger" type="button" id="filter-trigger">
        {% if current_language == "ta" %}வடிகட்டிகள்{% else %}Filters{% endif %}
        <span class="filter-badge" id="filter-badge"></span>
      </button>

      <!-- Filter backdrop -->
      <div class="filter-backdrop" id="filter-backdrop"></div>

      <section class="card filter-section" id="filter-section">
        <h2>{% if current_language == "ta" %}வடிகட்டிகள்{% else %}Filters{% endif %}</h2>
        <form class="filters" method="get" id="filter-form">
          <label>
            {% if current_language == "ta" %}ஆண்டு{% else %}Year{% endif %}
            <select name="year">
              <option value="2021" {% if year == "2021" %}selected{% endif %}>2021</option>
              <option value="2026" disabled style="color: #94a3b8;">2026 ({% if current_language == "ta" %}விரைவில்{% else %}coming soon{% endif %})</option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}குற்ற வழக்குகள்{% else %}Criminal cases{% endif %}
            <select name="cases">
              <option value="" {% if not selected_cases %}selected{% endif %}>{% if current_language == "ta" %}அனைத்தும்{% else %}All{% endif %}</option>
              <option value="0" {% if selected_cases == "0" %}selected{% endif %}>{% if current_language == "ta" %}இல்லை (0){% else %}None (0){% endif %}</option>
              <option value="1-5" {% if selected_cases == "1-5" %}selected{% endif %}>1 – 5</option>
              <option value="6+" {% if selected_cases == "6+" %}selected{% endif %}>6+</option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}வயது{% else %}Age{% endif %}
            <select name="age_group">
              <option value="" {% if not selected_age_group %}selected{% endif %}>{% if current_language == "ta" %}அனைத்தும்{% else %}All{% endif %}</option>
              <option value="under35" {% if selected_age_group == "under35" %}selected{% endif %}>{% if current_language == "ta" %}35க்கு கீழ்{% else %}Under 35{% endif %}</option>
              <option value="35-44" {% if selected_age_group == "35-44" %}selected{% endif %}>35 – 44</option>
              <option value="45-54" {% if selected_age_group == "45-54" %}selected{% endif %}>45 – 54</option>
              <option value="55+" {% if selected_age_group == "55+" %}selected{% endif %}>55+</option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}சொத்துகள் (₹){% else %}Assets (₹){% endif %}
            <select name="assets_range">
              <option value="" {% if not selected_assets_range %}selected{% endif %}>{% if current_language == "ta" %}அனைத்தும்{% else %}All{% endif %}</option>
              <option value="under10l" {% if selected_assets_range == "under10l" %}selected{% endif %}>{% if current_language == "ta" %}₹10 லட்சத்திற்கு கீழ்{% else %}Under ₹10 L{% endif %}</option>
              <option value="10l-1cr" {% if selected_assets_range == "10l-1cr" %}selected{% endif %}>₹10 L – ₹1 Cr</option>
              <option value="1cr-10cr" {% if selected_assets_range == "1cr-10cr" %}selected{% endif %}>₹1 Cr – ₹10 Cr</option>
              <option value="10cr+" {% if selected_assets_range == "10cr+" %}selected{% endif %}>₹10 Cr+</option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}தற்போதைய எம்.எல்.ஏ{% else %}Sitting MLA{% endif %}
            <select name="sitting_mla">
              <option value="" {% if not sitting_mla %}selected{% endif %}>
                {% if current_language == "ta" %}எல்லாம்{% else %}All{% endif %}
              </option>
              <option value="1" {% if sitting_mla == "1" %}selected{% endif %}>
                {% if current_language == "ta" %}ஆம்{% else %}Only sitting{% endif %}
              </option>
              <option value="0" {% if sitting_mla == "0" %}selected{% endif %}>
                {% if current_language == "ta" %}இல்லை{% else %}Exclude sitting{% endif %}
              </option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}கட்சிகள்{% else %}Parties{% endif %}
            <select name="party">
              <option value="" {% if not selected_party %}selected{% endif %}>
                {% if current_language == "ta" %}அனைத்தும்{% else %}All parties{% endif %}
              </option>
              <optgroup label="{% if current_language == 'ta' %}முக்கிய கட்சிகள்{% else %}Major parties{% endif %}">
                {% for party in party_options %}{% if party.is_prominent %}
                  <option value="{{ party.value }}" {% if party.value == selected_party %}selected{% endif %}>
                    {{ party.label }}
                  </option>
                {% endif %}{% endfor %}
              </optgroup>
              <optgroup label="{% if current_language == 'ta' %}பிற கட்சிகள்{% else %}Other parties{% endif %}">
                {% for party in party_options %}{% if not party.is_prominent %}
                  <option value="{{ party.value }}" {% if party.value == selected_party %}selected{% endif %}>
                    {{ party.label }}
                  </option>
                {% endif %}{% endfor %}
              </optgroup>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}மாவட்டம்{% else %}District{% endif %}
            <select name="district">
              <option value="" {% if not selected_district %}selected{% endif %}>
                {% if current_language == "ta" %}அனைத்தும்{% else %}All districts{% endif %}
              </option>
              {% for district in districts %}
                <option value="{{ district }}" {% if district == selected_district %}selected{% endif %}>{{ district }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}தொகுதி{% else %}Constituency{% endif %}
            <select name="constituency">
              <option value="" {% if not selected_constituency %}selected{% endif %}>
                {% if current_language == "ta" %}அனைத்தும்{% else %}All constituencies{% endif %}
              </option>
              {% for constituency in constituencies %}
                <option value="{{ constituency }}" {% if constituency == selected_constituency %}selected{% endif %}>{{ constituency }}</option>
              {% endfor %}
            </select>
          </label>
          <button type="submit" class="button">
            {% if current_language == "ta" %}பயன் காட்ட{% else %}Apply{% endif %}
          </button>
          <button type="button" class="btn-clear-filters" id="clear-filters">
            {% if current_language == "ta" %}அனைத்தையும் அழி{% else %}Clear all filters{% endif %}
          </button>
          <div class="filter-actions-mobile">
            <button type="submit" class="button">
              {% if current_language == "ta" %}பயன் காட்ட{% else %}Apply{% endif %}
            </button>
            <button type="button" class="btn-clear-filters" id="clear-filters-mobile">
              {% if current_language == "ta" %}அழி{% else %}Clear{% endif %}
            </button>
            <button type="button" class="filter-close-btn" id="filter-close">
              {% if current_language == "ta" %}மூடு{% else %}Close{% endif %}
            </button>
          </div>
        </form>
        <p class="muted" id="filter-row-count">
          {% if current_language == "ta" %}
            வடிகட்டிகளுக்குப் பிறகு: {{ rows_count|indian }} வேட்பாளர் பதிவுகள்.
          {% else %}
            After filters: {{ rows_count|indian }} candidate rows.
          {% endif %}
        </p>
      </section>

      <section class="card">
        <h2>{% if current_language == "ta" %}கட்சிகள் ஒரு பார்வை{% else %}Party snapshot{% endif %}</h2>

        <!-- Search bar -->
        <div class="party-search-container">
          <div class="party-search-input-wrapper">
            <input
              type="text"
              id="party-search-input"
              class="party-search-input"
              placeholder="{% if current_language == 'ta' %}கட்சி அல்லது வேட்பாளரைத் தேடுங்கள்...{% else %}Search party or candidate...{% endif %}"
              autocomplete="off"
              aria-label="{% if current_language == 'ta' %}கட்சி தேடல்{% else %}Search party or candidate{% endif %}"
            />
            <button type="button" class="party-search-clear" id="party-search-clear" aria-label="Clear search">&times;</button>
            <div class="party-search-dropdown" id="party-search-dropdown"></div>
          </div>
        </div>

        {% if party_stats %}

        <!-- View toggle toolbar -->
        <div class="view-toolbar">
          <div class="view-toggle">
            <button class="view-btn active" data-view="table" type="button">
              {% if current_language == "ta" %}அட்டவணை{% else %}Table{% endif %}
            </button>
            <button class="view-btn" data-view="cards" type="button">
              {% if current_language == "ta" %}அட்டைகள்{% else %}Cards{% endif %}
            </button>
          </div>
          <div class="card-sort" id="card-sort" style="display:none">
            <label>
              {% if current_language == "ta" %}வரிசைப்படுத்து{% else %}Sort by{% endif %}
              <select id="card-sort-select">
                <option value="candidate_count" selected>{% if current_language == "ta" %}வேட்பாளர்கள்{% else %}Candidates{% endif %}</option>
                <option value="party">{% if current_language == "ta" %}கட்சி{% else %}Party{% endif %}</option>
                <option value="avg_cases">{% if current_language == "ta" %}சராசரி வழக்குகள்{% else %}Avg criminal cases{% endif %}</option>
                <option value="cases_pct">{% if current_language == "ta" %}குற்ற வழக்கு %{% else %}% w/ criminal cases{% endif %}</option>
                <option value="avg_age">{% if current_language == "ta" %}சராசரி வயது{% else %}Avg age{% endif %}</option>
                <option value="avg_assets">{% if current_language == "ta" %}சராசரி சொத்து{% else %}Avg assets{% endif %}</option>
              </select>
            </label>
            <button type="button" class="sort-dir-btn" id="sort-dir-btn" data-dir="desc" title="Sorted descending">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v10M4 9l4 4 4-4"/></svg>
            </button>
          </div>
        </div>

        <!-- Table view -->
        <div id="table-view">
        <table class="table" id="party-table">
          <thead>
            <tr>
              <th><button class="sort-link" type="button" data-sort="party">{% if current_language == "ta" %}கட்சி{% else %}Party{% endif %} <span class="sort-indicator">↕</span></button></th>
              <th><button class="sort-link active" type="button" data-sort="candidate_count">{% if current_language == "ta" %}வேட்பாளர் எண்ணிக்கை{% else %}Candidates{% endif %} <span class="sort-indicator active">▼</span></button></th>
              <th><button class="sort-link" type="button" data-sort="avg_cases">{% if current_language == "ta" %}சராசரி குற்ற வழக்குகள்{% else %}Avg criminal cases{% endif %} <span class="sort-indicator">↕</span></button></th>
              <th><button class="sort-link" type="button" data-sort="cases_pct">{% if current_language == "ta" %}குற்ற வழக்குகள் உள்ளவர்களின் விகிதம்{% else %}% w/ criminal cases{% endif %} <span class="sort-indicator">↕</span></button></th>
              <th><button class="sort-link" type="button" data-sort="avg_age">{% if current_language == "ta" %}சராசரி வயது{% else %}Avg. age{% endif %} <span class="sort-indicator">↕</span></button></th>
              <th><button class="sort-link" type="button" data-sort="avg_assets">{% if current_language == "ta" %}சராசரி சொத்து (₹){% else %}Avg. assets (₹){% endif %} <span class="sort-indicator">↕</span></button></th>
              <th><button class="sort-link" type="button" data-sort="top_education">{% if current_language == "ta" %}அதிகம் காணப்படும் கல்வி{% else %}Most common education{% endif %} <span class="sort-indicator">↕</span></button></th>
            </tr>
          </thead>
          <tbody>
            {% for party in party_stats %}
            <tr data-party="{{ party.party }}"
                data-candidate_count="{{ party.candidate_count }}"
                data-avg_cases="{{ party.avg_cases|default:0 }}"
                data-cases_pct="{{ party.cases_pct|default:0 }}"
                data-avg_age="{{ party.avg_age|default:0 }}"
                data-avg_assets="{{ party.avg_assets|default:0 }}"
                data-top_education="{{ party.top_education|default:"" }}">
              <td>
                <div class="party-cell">
                  {% if party.party_symbol %}
                    <img
                      class="party-symbol"
                      src="{{ party.party_symbol }}"
                      alt="{{ party.party }} symbol"
                      onerror="this.style.display='none'"
                    />
                  {% endif %}
                  <a class="link" href="/party/{{ party.party|urlencode }}/{% if base_query_no_party %}?{{ base_query_no_party }}{% endif %}">
                    {{ party.party_display|default:party.party }}
                  </a>
                </div>
              </td>
              <td>{{ party.candidate_count|indian }}</td>
              <td>{% if party.avg_cases is not None %}{{ party.avg_cases|indian }}{% else %}—{% endif %}</td>
              <td>{{ party.cases_pct|indian }}%</td>
              <td>{% if party.avg_age is not None %}{{ party.avg_age|indian }}{% else %}—{% endif %}</td>
              <td>{% if party.avg_assets is not None %}<span title="₹ {{ party.avg_assets|indian }}">₹ {{ party.avg_assets|short_indian }}</span>{% else %}—{% endif %}</td>
              <td>{% if party.top_education %}{{ party.top_education }}{% else %}—{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>

        <!-- Card view (hidden by default, shown on mobile or via toggle) -->
        <div class="card-grid" id="card-view" style="display:none">
          {% for party in party_stats %}
          <a class="data-card data-card-link"
             href="/party/{{ party.party|urlencode }}/{% if base_query_no_party %}?{{ base_query_no_party }}{% endif %}"
             data-party="{{ party.party }}"
             data-candidate_count="{{ party.candidate_count }}"
             data-avg_cases="{{ party.avg_cases|default:0 }}"
             data-cases_pct="{{ party.cases_pct|default:0 }}"
             data-avg_age="{{ party.avg_age|default:0 }}"
             data-avg_assets="{{ party.avg_assets|default:0 }}"
             data-top_education="{{ party.top_education|default:"" }}">
            <div class="data-card-header">
              {% if party.party_symbol %}
                <img
                  class="party-symbol"
                  src="{{ party.party_symbol }}"
                  alt="{{ party.party }} symbol"
                  onerror="this.style.display='none'"
                />
              {% endif %}
              <span>{{ party.party_display|default:party.party }}</span>
            </div>
            <dl class="data-card-body">
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}வேட்பாளர்கள்{% else %}Candidates{% endif %}</dt>
                <dd>{{ party.candidate_count|indian }}</dd>
              </div>
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}சராசரி குற்ற வழக்குகள்{% else %}Avg criminal cases{% endif %}</dt>
                <dd>{% if party.avg_cases is not None %}{{ party.avg_cases|indian }}{% else %}—{% endif %}</dd>
              </div>
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}குற்ற வழக்கு %{% else %}% w/ criminal cases{% endif %}</dt>
                <dd>{{ party.cases_pct|default:"—" }}%</dd>
              </div>
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}சராசரி வயது{% else %}Avg. age{% endif %}</dt>
                <dd>{% if party.avg_age is not None %}{{ party.avg_age|indian }}{% else %}—{% endif %}</dd>
              </div>
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}சராசரி சொத்து{% else %}Avg. assets{% endif %}</dt>
                <dd>{% if party.avg_assets is not None %}<span title="₹ {{ party.avg_assets|indian }}">₹ {{ party.avg_assets|short_indian }}</span>{% else %}—{% endif %}</dd>
              </div>
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}அதிகம் காணப்படும் கல்வி{% else %}Most common education{% endif %}</dt>
                <dd>{% if party.top_education %}{{ party.top_education }}{% else %}—{% endif %}</dd>
              </div>
            </dl>
          </a>
          {% endfor %}
        </div>

        {% else %}
        <p class="muted">
          {% if current_language == "ta" %}
            CSV தரவுகள் கிடைக்கவில்லை.
          {% else %}
            No CSV data found.
          {% endif %}
        </p>
        {% endif %}
      </section>
    </main>
    <script>
      /* ---- Filter persistence (sessionStorage) ---- */
      var STORAGE_KEY = 'tntracker_filters_' + window.location.pathname;

      /* Save current URL params */
      if (window.location.search) {
        sessionStorage.setItem(STORAGE_KEY, window.location.search.substring(1));
      }

      /* ---- AJAX filter submission ---- */
      (function () {
        var form = document.getElementById('filter-form');
        if (!form) return;

        function applyFilters(qs) {
          var url = window.location.pathname + '?' + qs;
          fetch(url).then(function (r) { return r.text(); }).then(function (html) {
            var doc = new DOMParser().parseFromString(html, 'text/html');

            /* Replace overview tiles */
            var newTiles = doc.querySelector('.overview-tiles');
            var oldTiles = document.querySelector('.overview-tiles');
            if (newTiles && oldTiles) oldTiles.innerHTML = newTiles.innerHTML;

            /* Replace table tbody */
            var newTbody = doc.querySelector('#party-table tbody');
            var oldTbody = document.querySelector('#party-table tbody');
            if (newTbody && oldTbody) oldTbody.innerHTML = newTbody.innerHTML;

            /* Replace card view */
            var newCards = doc.querySelector('#card-view');
            var oldCards = document.querySelector('#card-view');
            if (newCards && oldCards) oldCards.innerHTML = newCards.innerHTML;

            /* Replace row count */
            var newCount = doc.querySelector('#filter-row-count');
            var oldCount = document.querySelector('#filter-row-count');
            if (newCount && oldCount) oldCount.innerHTML = newCount.innerHTML;

            /* Update constituency dropdown options */
            var newConst = doc.querySelector('select[name="constituency"]');
            var oldConst = document.querySelector('select[name="constituency"]');
            if (newConst && oldConst) oldConst.innerHTML = newConst.innerHTML;

            /* Update URL bar */
            history.pushState(null, '', url);
            sessionStorage.setItem(STORAGE_KEY, qs);

            /* Re-init table sort on new tbody rows */
            initTableSort();

            /* Update filter badge */
            updateFilterBadge();

            /* Close mobile drawer if open */
            closeFilters();
          });
        }

        form.addEventListener('submit', function (e) {
          e.preventDefault();
          var qs = new URLSearchParams(new FormData(form)).toString();
          applyFilters(qs);
        });

        /* Clear all filters */
        function clearAllFilters(e) {
          e.preventDefault();
          var qs = 'year=2021';
          /* Reset all selects to first option */
          form.querySelectorAll('select').forEach(function (s) {
            if (s.name === 'year') { s.value = '2021'; }
            else { s.selectedIndex = 0; }
          });
          applyFilters(qs);
        }
        var clearBtn = document.getElementById('clear-filters');
        var clearBtnMobile = document.getElementById('clear-filters-mobile');
        if (clearBtn) clearBtn.addEventListener('click', clearAllFilters);
        if (clearBtnMobile) clearBtnMobile.addEventListener('click', clearAllFilters);

        /* Handle browser back/forward */
        window.addEventListener('popstate', function () {
          var qs = window.location.search.substring(1) || 'year=2021';
          /* Sync form selects with URL params */
          var params = new URLSearchParams(qs);
          form.querySelectorAll('select').forEach(function (s) {
            var val = params.get(s.name) || '';
            s.value = val;
          });
          applyFilters(qs);
        });
      })();

      /* ---- View toggle (Table / Cards) ---- */
      (function () {
        const tableView = document.getElementById("table-view");
        const cardView = document.getElementById("card-view");
        const cardSort = document.getElementById("card-sort");
        const btns = document.querySelectorAll(".view-btn");
        if (!tableView || !cardView) return;

        function setView(mode) {
          btns.forEach((b) => b.classList.toggle("active", b.dataset.view === mode));
          tableView.style.display = mode === "table" ? "" : "none";
          cardView.style.display = mode === "cards" ? "grid" : "none";
          if (cardSort) cardSort.style.display = mode === "cards" ? "" : "none";
        }

        btns.forEach((btn) => {
          btn.addEventListener("click", () => setView(btn.dataset.view));
        });

        /* Default to cards on mobile */
        if (window.matchMedia("(max-width: 768px)").matches) {
          setView("cards");
        }
      })();

      /* ---- Card sort ---- */
      (function () {
        const select = document.getElementById("card-sort-select");
        const container = document.getElementById("card-view");
        const dirBtn = document.getElementById("sort-dir-btn");
        if (!select || !container || !dirBtn) return;

        function sortCards() {
          const key = select.value;
          const dir = dirBtn.dataset.dir === "asc" ? 1 : -1;
          const cards = [...container.querySelectorAll(".data-card")];

          cards.sort((a, b) => {
            let va = a.dataset[key] || "";
            let vb = b.dataset[key] || "";
            const na = parseFloat(va);
            const nb = parseFloat(vb);
            if (!isNaN(na) && !isNaN(nb)) return (na - nb) * dir;
            return va.localeCompare(vb, undefined, { sensitivity: "base" }) * dir;
          });

          cards.forEach((c) => container.appendChild(c));
        }

        select.addEventListener("change", sortCards);
        dirBtn.addEventListener("click", function () {
          const isDesc = this.dataset.dir === "desc";
          this.dataset.dir = isDesc ? "asc" : "desc";
          this.innerHTML = isDesc
            ? '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 13V3M4 7l4-4 4 4"/></svg>'
            : '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v10M4 9l4 4 4-4"/></svg>';
          this.title = isDesc ? "Sorted ascending" : "Sorted descending";
          sortCards();
        });
      })();

      /* ---- Table sort (client-side) ---- */
      var _tableSortState = { field: "candidate_count", asc: false };

      function initTableSort() {
        var table = document.getElementById("party-table");
        if (!table) return;
        var tbody = table.querySelector("tbody");
        var headers = table.querySelectorAll("thead .sort-link");

        /* Remove old listeners by cloning */
        headers.forEach(function (btn) {
          var clone = btn.cloneNode(true);
          btn.parentNode.replaceChild(clone, btn);
        });

        /* Re-query after cloning */
        headers = table.querySelectorAll("thead .sort-link");

        function sortTable(field) {
          if (_tableSortState.field === field) {
            _tableSortState.asc = !_tableSortState.asc;
          } else {
            _tableSortState.field = field;
            _tableSortState.asc = false;
          }
          var rows = [].slice.call(tbody.querySelectorAll("tr"));
          var dir = _tableSortState.asc ? 1 : -1;
          rows.sort(function (a, b) {
            var va = a.dataset[field] || "";
            var vb = b.dataset[field] || "";
            var na = parseFloat(va);
            var nb = parseFloat(vb);
            if (!isNaN(na) && !isNaN(nb)) return (na - nb) * dir;
            return va.localeCompare(vb, undefined, { sensitivity: "base" }) * dir;
          });
          rows.forEach(function (r) { tbody.appendChild(r); });
          headers.forEach(function (btn) {
            var ind = btn.querySelector(".sort-indicator");
            if (btn.dataset.sort === field) {
              btn.classList.add("active");
              ind.classList.add("active");
              ind.textContent = _tableSortState.asc ? "▲" : "▼";
            } else {
              btn.classList.remove("active");
              ind.classList.remove("active");
              ind.textContent = "↕";
            }
          });
        }

        headers.forEach(function (btn) {
          btn.addEventListener("click", function () { sortTable(btn.dataset.sort); });
        });
      }
      initTableSort();

      /* ---- Mobile filter drawer ---- */
      function closeFilters() {
        var section = document.getElementById("filter-section");
        var backdrop = document.getElementById("filter-backdrop");
        if (section) section.classList.remove("open");
        if (backdrop) backdrop.classList.remove("open");
        document.body.style.overflow = "";
      }

      function updateFilterBadge() {
        var count = 0;
        document.querySelectorAll("#filter-form select").forEach(function (s) {
          if (s.name !== 'year' && s.selectedIndex > 0) count++;
        });
        var badge = document.getElementById("filter-badge");
        if (badge) badge.textContent = count || "";
      }

      (function () {
        var trigger = document.getElementById("filter-trigger");
        var section = document.getElementById("filter-section");
        var backdrop = document.getElementById("filter-backdrop");
        var closeBtn = document.getElementById("filter-close");

        function openFilters() {
          section.classList.add("open");
          backdrop.classList.add("open");
          document.body.style.overflow = "hidden";
        }

        if (trigger) trigger.addEventListener("click", openFilters);
        if (closeBtn) closeBtn.addEventListener("click", closeFilters);
        if (backdrop) backdrop.addEventListener("click", closeFilters);

        updateFilterBadge();
      })();

      /* ---- Party / Candidate search autocomplete ---- */
      (function () {
        var searchInput = document.getElementById('party-search-input');
        var searchDropdown = document.getElementById('party-search-dropdown');
        var searchClear = document.getElementById('party-search-clear');
        if (!searchInput || !searchDropdown) return;

        var searchTimeout = null;
        var highlightedIndex = -1;
        var searchResults = [];
        var currentLang = '{{ current_language }}';
        var currentYear = '{{ year }}';

        function showDropdown() { searchDropdown.classList.add('active'); }
        function hideDropdown() { searchDropdown.classList.remove('active'); highlightedIndex = -1; }

        function renderDropdown(results, loading) {
          searchResults = results || [];
          highlightedIndex = -1;
          if (loading) {
            searchDropdown.innerHTML = '<div class="party-search-dropdown-empty">' +
              (currentLang === 'ta' ? 'தேடுகிறது...' : 'Searching...') + '</div>';
            showDropdown();
            return;
          }
          if (!searchResults.length) {
            searchDropdown.innerHTML = '<div class="party-search-dropdown-empty">' +
              (currentLang === 'ta' ? 'முடிவுகள் இல்லை' : 'No results found') + '</div>';
            showDropdown();
            return;
          }
          searchDropdown.innerHTML = searchResults.map(function (r, i) {
            var icon = '';
            if (r.type === 'party' && r.symbol_url) {
              icon = '<img class="party-search-symbol" src="' + r.symbol_url + '" alt="" onerror="this.style.display=\'none\'" />';
            }
            var name = r.type === 'party' ? r.display_name : r.name;
            var subtitle = '';
            if (r.type === 'candidate') {
              subtitle = r.party_display + (r.constituency ? ' · ' + r.constituency : '');
            }
            var typeLabel = r.type === 'party'
              ? (currentLang === 'ta' ? 'கட்சி' : 'Party')
              : (currentLang === 'ta' ? 'வேட்பாளர்' : 'Candidate');
            return '<div class="party-search-dropdown-item' +
              (r.type === 'candidate' ? ' party-search-dropdown-item-candidate' : '') +
              '" data-index="' + i + '">' +
              '<div class="party-search-dropdown-item-main">' +
              icon +
              '<div class="party-search-dropdown-item-text">' +
              '<div class="party-search-dropdown-item-name">' + name + '</div>' +
              (subtitle ? '<div class="party-search-dropdown-item-sub">' + subtitle + '</div>' : '') +
              '</div></div>' +
              '<span class="party-search-dropdown-item-type">' + typeLabel + '</span>' +
              '</div>';
          }).join('');
          showDropdown();
        }

        function doSearch(q) {
          if (q.length < 2) { hideDropdown(); return; }
          renderDropdown([], true);
          fetch('/api/party-dashboard-search/?q=' + encodeURIComponent(q) + '&year=' + currentYear)
            .then(function (r) { return r.json(); })
            .then(function (data) { renderDropdown(data.results); })
            .catch(function () { renderDropdown([]); });
        }

        searchInput.addEventListener('input', function () {
          clearTimeout(searchTimeout);
          var q = this.value.trim();
          searchTimeout = setTimeout(function () { doSearch(q); }, 350);
        });

        if (searchClear) {
          searchClear.addEventListener('click', function () {
            searchInput.value = '';
            hideDropdown();
          });
        }

        function scrollAndHighlight(target) {
          var headerOffset = 70;
          var top = target.getBoundingClientRect().top + window.pageYOffset - headerOffset;
          window.scrollTo({ top: top, behavior: 'smooth' });
          target.classList.add('search-highlighted');
          setTimeout(function () { target.classList.remove('search-highlighted'); }, 3500);
        }

        function selectResult(result) {
          hideDropdown();
          searchInput.value = '';
          if (result.type === 'candidate') {
            /* Navigate to the party detail page with highlight param */
            var partyUrl = '/party/' + encodeURIComponent(result.party) + '/?year=' + currentYear
              + '&highlight=' + encodeURIComponent(result.name);
            window.location.href = partyUrl;
            return;
          }
          /* Party result: scroll to card/row and highlight */
          var partyName = result.name;
          var tableView = document.getElementById('table-view');
          var cardView = document.getElementById('card-view');
          var target = null;
          if (cardView && cardView.style.display !== 'none') {
            target = cardView.querySelector('.data-card[data-party="' + CSS.escape(partyName) + '"]');
          }
          if (!target && tableView && tableView.style.display !== 'none') {
            target = tableView.querySelector('tr[data-party="' + CSS.escape(partyName) + '"]');
          }
          if (target) {
            scrollAndHighlight(target);
          }
        }

        /* Click handler on dropdown items */
        searchDropdown.addEventListener('click', function (e) {
          var item = e.target.closest('.party-search-dropdown-item');
          if (!item) return;
          var idx = parseInt(item.dataset.index, 10);
          if (searchResults[idx]) selectResult(searchResults[idx]);
        });

        /* Keyboard navigation */
        searchInput.addEventListener('keydown', function (e) {
          var items = searchDropdown.querySelectorAll('.party-search-dropdown-item');
          if (!items.length) return;
          if (e.key === 'ArrowDown') {
            e.preventDefault();
            highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            highlightedIndex = Math.max(highlightedIndex - 1, 0);
          } else if (e.key === 'Enter' && highlightedIndex >= 0) {
            e.preventDefault();
            if (searchResults[highlightedIndex]) selectResult(searchResults[highlightedIndex]);
            return;
          } else if (e.key === 'Escape') {
            hideDropdown();
            return;
          } else {
            return;
          }
          items.forEach(function (el, i) {
            el.classList.toggle('highlighted', i === highlightedIndex);
          });
          items[highlightedIndex].scrollIntoView({ block: 'nearest' });
        });

        /* Close dropdown on outside click */
        document.addEventListener('click', function (e) {
          if (!e.target.closest('.party-search-container')) hideDropdown();
        });
      })();
    </script>
    {% include "core/_footer.html" %}
    {% include "core/_consent_dialog.html" %}
    {% include "core/_feedback_widget.html" %}
  </body>
</html>
