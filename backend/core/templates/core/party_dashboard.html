<!DOCTYPE html>
<html lang="en">
  {% load indian_numbers %}
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Party Dashboard</title>
    <link rel="stylesheet" href="/static/core/site.css" />
  </head>
  <body>
    <header class="site-header compact">
      <div class="container nav">
        <a class="brand-link" href="/">
          <div class="brand">
            <img class="brand-logo" src="/static/core/logo.png" alt="Tamil Nadu Election Tracker" />
            <div class="brand-text">
              <div class="brand-title">
                {% if current_language == "ta" %}தமிழ்நாடு தேர்தல் கண்காணிப்பான்{% else %}Tamil Nadu Election Tracker{% endif %}
              </div>
              <div class="brand-subtitle">
                {% if current_language == "ta" %}2026 சட்டமன்றத் தேர்தல்{% else %}Assembly Elections 2026{% endif %}
              </div>
            </div>
          </div>
        </a>
        <div class="nav-links">
          <a class="nav-link" href="/map/">{% if current_language == "ta" %}வரைபடம்{% else %}Maps{% endif %}</a>
          <a class="nav-link nav-link-active" href="/party-dashboard/">{% if current_language == "ta" %}வேட்பாளர்களை அறியவும்{% else %}Know your Candidates{% endif %}</a>
          <a class="nav-link" href="/resources/">{% if current_language == "ta" %}வளங்கள்{% else %}Resources{% endif %}</a>
        </div>
      </div>
    </header>
    <main class="container">
      <div class="topbar">
        <div class="lang">
          <a class="link" href="/set-lang/en/?next={{ request.get_full_path|urlencode }}">English</a>
          <span> | </span>
          <a class="link" href="/set-lang/ta/?next={{ request.get_full_path|urlencode }}">தமிழ்</a>
        </div>
      </div>
      {% if data_vintage_label %}
      <div class="banner">{{ data_vintage_label }}</div>
      {% endif %}
      <a class="link" href="/">← {% if current_language == "ta" %}முகப்பு{% else %}Back to home{% endif %}</a>
      <h1>{% if current_language == "ta" %}கட்சி காட்சிப்பலகை{% else %}Party Dashboard{% endif %}</h1>
      <p class="muted">
        {% if current_language == "ta" %}
          CSV தரவின் அடிப்படையில் கட்சிப் படிநிலைகள் மற்றும் சராசரிகள்.
        {% else %}
          Party-level aggregates based on the candidate CSV data.
        {% endif %}
      </p>

      <section class="card">
        <h2>{% if current_language == "ta" %}மேலோட்டம்{% else %}Overview{% endif %}</h2>
        <dl class="grid">
          <div>
            <dt>{% if current_language == "ta" %}மொத்த கட்சிகள்{% else %}Total parties{% endif %}</dt>
            <dd>{{ total_parties|indian }}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}மொத்த வேட்பாளர்கள்{% else %}Total candidates{% endif %}</dt>
            <dd>{{ total_candidates|indian }}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}சராசரி குற்ற வழக்குகள்{% else %}Avg. criminal cases{% endif %}</dt>
            <dd>{% if overall_avg_cases is not None %}{{ overall_avg_cases|indian }}{% else %}—{% endif %}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}சராசரி வயது{% else %}Avg. age{% endif %}</dt>
            <dd>{% if overall_avg_age is not None %}{{ overall_avg_age|indian }}{% else %}—{% endif %}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}சராசரி சொத்து (₹){% else %}Avg. assets (₹){% endif %}</dt>
            <dd>{% if overall_avg_assets is not None %}₹ {{ overall_avg_assets|indian }}{% else %}—{% endif %}</dd>
          </div>
          <div>
            <dt>{% if current_language == "ta" %}சராசரி கடன்கள் (₹){% else %}Avg. liabilities (₹){% endif %}</dt>
            <dd>{% if overall_avg_liabilities is not None %}₹ {{ overall_avg_liabilities|indian }}{% else %}—{% endif %}</dd>
          </div>
        </dl>
      </section>

      <!-- Mobile filter trigger (hidden on desktop via CSS) -->
      <button class="filter-trigger" type="button" id="filter-trigger">
        {% if current_language == "ta" %}வடிகட்டிகள்{% else %}Filters{% endif %}
        <span class="filter-badge" id="filter-badge"></span>
      </button>

      <!-- Filter backdrop -->
      <div class="filter-backdrop" id="filter-backdrop"></div>

      <section class="card filter-section" id="filter-section">
        <h2>{% if current_language == "ta" %}வடிகட்டிகள்{% else %}Filters{% endif %}</h2>
        <form class="filters" method="get" id="filter-form">
          <label>
            {% if current_language == "ta" %}ஆண்டு{% else %}Year{% endif %}
            <select name="year">
              <option value="2021" {% if year == "2021" %}selected{% endif %}>2021</option>
              <option value="2026" {% if year == "2026" %}selected{% endif %}>2026</option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}குற்ற வழக்குகள்{% else %}Criminal cases{% endif %}
            <div class="range-wrap">
              <div class="range-pair">
                <input
                  type="range"
                  name="min_cases"
                  min="{{ cases_bounds.0 }}"
                  max="{{ cases_bounds.1 }}"
                  value="{{ min_cases }}"
                  step="1"
                />
                <input
                  type="range"
                  name="max_cases"
                  min="{{ cases_bounds.0 }}"
                  max="{{ cases_bounds.1 }}"
                  value="{{ max_cases|default:cases_bounds.1 }}"
                  step="1"
                />
              </div>
              <div class="range-values">
                <output class="min-value">{{ min_cases|indian }}</output>
                <span>–</span>
                <output class="max-value">{{ max_cases|default:cases_bounds.1|indian }}</output>
              </div>
            </div>
          </label>
          <label>
            {% if current_language == "ta" %}வயது{% else %}Age{% endif %}
            <div class="range-wrap">
              <div class="range-pair">
                <input
                  type="range"
                  name="min_age"
                  min="{{ age_bounds.0 }}"
                  max="{{ age_bounds.1 }}"
                  value="{{ min_age }}"
                  step="1"
                />
                <input
                  type="range"
                  name="max_age"
                  min="{{ age_bounds.0 }}"
                  max="{{ age_bounds.1 }}"
                  value="{{ max_age }}"
                  step="1"
                />
              </div>
              <div class="range-values">
                <output class="min-value">{{ min_age|indian }}</output>
                <span>–</span>
                <output class="max-value">{{ max_age|indian }}</output>
              </div>
            </div>
          </label>
          <label>
            {% if current_language == "ta" %}சொத்துகள் (₹){% else %}Assets (₹){% endif %}
            <div class="range-wrap">
              <div class="range-pair">
                <input
                  type="range"
                  name="min_assets"
                  min="{{ assets_bounds.0 }}"
                  max="{{ assets_bounds.1 }}"
                  value="{{ min_assets }}"
                  step="1"
                />
                <input
                  type="range"
                  name="max_assets"
                  min="{{ assets_bounds.0 }}"
                  max="{{ assets_bounds.1 }}"
                  value="{{ max_assets }}"
                  step="1"
                />
              </div>
              <div class="range-values">
                <output class="min-value">{{ min_assets|indian }}</output>
                <span>–</span>
                <output class="max-value">{{ max_assets|indian }}</output>
              </div>
            </div>
          </label>
          <label>
            {% if current_language == "ta" %}பாக்கிகள் (₹){% else %}Liabilities (₹){% endif %}
            <div class="range-wrap">
              <div class="range-pair">
                <input
                  type="range"
                  name="min_liabilities"
                  min="{{ liabilities_bounds.0 }}"
                  max="{{ liabilities_bounds.1 }}"
                  value="{{ min_liabilities }}"
                  step="1"
                />
                <input
                  type="range"
                  name="max_liabilities"
                  min="{{ liabilities_bounds.0 }}"
                  max="{{ liabilities_bounds.1 }}"
                  value="{{ max_liabilities }}"
                  step="1"
                />
              </div>
              <div class="range-values">
                <output class="min-value">{{ min_liabilities|indian }}</output>
                <span>–</span>
                <output class="max-value">{{ max_liabilities|indian }}</output>
              </div>
            </div>
          </label>
          <label>
            {% if current_language == "ta" %}தற்போதைய எம்.எல்.ஏ{% else %}Sitting MLA{% endif %}
            <select name="sitting_mla">
              <option value="" {% if not sitting_mla %}selected{% endif %}>
                {% if current_language == "ta" %}எல்லாம்{% else %}All{% endif %}
              </option>
              <option value="1" {% if sitting_mla == "1" %}selected{% endif %}>
                {% if current_language == "ta" %}ஆம்{% else %}Only sitting{% endif %}
              </option>
              <option value="0" {% if sitting_mla == "0" %}selected{% endif %}>
                {% if current_language == "ta" %}இல்லை{% else %}Exclude sitting{% endif %}
              </option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}கட்சிகள்{% else %}Parties{% endif %}
            <select name="party">
              <option value="" {% if not selected_party %}selected{% endif %}>
                {% if current_language == "ta" %}அனைத்தும்{% else %}All parties{% endif %}
              </option>
              {% for party in party_options %}
                <option value="{{ party.value }}" {% if party.value == selected_party %}selected{% endif %}>
                  {{ party.label }}
                </option>
              {% endfor %}
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}மாவட்டம்{% else %}District{% endif %}
            <select name="district">
              <option value="" {% if not selected_district %}selected{% endif %}>
                {% if current_language == "ta" %}அனைத்தும்{% else %}All districts{% endif %}
              </option>
              {% for district in districts %}
                <option value="{{ district }}" {% if district == selected_district %}selected{% endif %}>{{ district }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}தொகுதி{% else %}Constituency{% endif %}
            <select name="constituency">
              <option value="" {% if not selected_constituency %}selected{% endif %}>
                {% if current_language == "ta" %}அனைத்தும்{% else %}All constituencies{% endif %}
              </option>
              {% for constituency in constituencies %}
                <option value="{{ constituency }}" {% if constituency == selected_constituency %}selected{% endif %}>{{ constituency }}</option>
              {% endfor %}
            </select>
          </label>
          <button type="submit" class="button">
            {% if current_language == "ta" %}பயன் காட்ட{% else %}Apply{% endif %}
          </button>
          <div class="filter-actions-mobile">
            <button type="submit" class="button">
              {% if current_language == "ta" %}பயன் காட்ட{% else %}Apply{% endif %}
            </button>
            <button type="button" class="filter-close-btn" id="filter-close">
              {% if current_language == "ta" %}மூடு{% else %}Close{% endif %}
            </button>
          </div>
        </form>
        <p class="muted">
          {% if current_language == "ta" %}
            வடிகட்டிகளுக்குப் பிறகு: {{ rows_count|indian }} வேட்பாளர் பதிவுகள்.
          {% else %}
            After filters: {{ rows_count|indian }} candidate rows.
          {% endif %}
        </p>
      </section>

      <section class="card">
        <h2>{% if current_language == "ta" %}கட்சிகள் ஒரு பார்வை{% else %}Party snapshot{% endif %}</h2>
        {% if party_stats %}

        <!-- View toggle toolbar -->
        <div class="view-toolbar">
          <div class="view-toggle">
            <button class="view-btn active" data-view="table" type="button">
              {% if current_language == "ta" %}அட்டவணை{% else %}Table{% endif %}
            </button>
            <button class="view-btn" data-view="cards" type="button">
              {% if current_language == "ta" %}அட்டைகள்{% else %}Cards{% endif %}
            </button>
          </div>
          <div class="card-sort" id="card-sort" style="display:none">
            <label>
              {% if current_language == "ta" %}வரிசைப்படுத்து{% else %}Sort by{% endif %}
              <select id="card-sort-select">
                <option value="party" data-dir="asc">{% if current_language == "ta" %}கட்சி (அ-ஃ){% else %}Party (A-Z){% endif %}</option>
                <option value="party" data-dir="desc">{% if current_language == "ta" %}கட்சி (ஃ-அ){% else %}Party (Z-A){% endif %}</option>
                <option value="candidate_count" data-dir="desc" selected>{% if current_language == "ta" %}வேட்பாளர்கள் (அதிகம்){% else %}Candidates (high-low){% endif %}</option>
                <option value="candidate_count" data-dir="asc">{% if current_language == "ta" %}வேட்பாளர்கள் (குறைவு){% else %}Candidates (low-high){% endif %}</option>
                <option value="avg_cases" data-dir="desc">{% if current_language == "ta" %}சராசரி வழக்குகள் (அதிகம்){% else %}Avg cases (high-low){% endif %}</option>
                <option value="avg_cases" data-dir="asc">{% if current_language == "ta" %}சராசரி வழக்குகள் (குறைவு){% else %}Avg cases (low-high){% endif %}</option>
                <option value="cases_pct" data-dir="desc">{% if current_language == "ta" %}வழக்கு % (அதிகம்){% else %}Cases % (high-low){% endif %}</option>
                <option value="cases_pct" data-dir="asc">{% if current_language == "ta" %}வழக்கு % (குறைவு){% else %}Cases % (low-high){% endif %}</option>
                <option value="avg_age" data-dir="desc">{% if current_language == "ta" %}சராசரி வயது (அதிகம்){% else %}Avg age (high-low){% endif %}</option>
                <option value="avg_age" data-dir="asc">{% if current_language == "ta" %}சராசரி வயது (குறைவு){% else %}Avg age (low-high){% endif %}</option>
                <option value="avg_assets" data-dir="desc">{% if current_language == "ta" %}சராசரி சொத்து (அதிகம்){% else %}Avg assets (high-low){% endif %}</option>
                <option value="avg_assets" data-dir="asc">{% if current_language == "ta" %}சராசரி சொத்து (குறைவு){% else %}Avg assets (low-high){% endif %}</option>
                <option value="avg_liabilities" data-dir="desc">{% if current_language == "ta" %}சராசரி கடன் (அதிகம்){% else %}Avg liabilities (high-low){% endif %}</option>
                <option value="avg_liabilities" data-dir="asc">{% if current_language == "ta" %}சராசரி கடன் (குறைவு){% else %}Avg liabilities (low-high){% endif %}</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Table view -->
        <div id="table-view">
        <table class="table">
          <thead>
            <tr>
              <th>
                <a class="link sort-link" href="?{{ base_query }}&sort=party&order={% if sort_key == 'party' and sort_order == 'desc' %}asc{% else %}desc{% endif %}">
                  {% if current_language == "ta" %}கட்சி{% else %}Party{% endif %}
                  <span class="sort-indicator{% if sort_key == 'party' %} active{% endif %}">
                    {% if sort_key == "party" %}
                      {% if sort_order == "asc" %}▲{% else %}▼{% endif %}
                    {% else %}
                      ↕
                    {% endif %}
                  </span>
                </a>
              </th>
              <th>
                <a class="link sort-link" href="?{{ base_query }}&sort=candidate_count&order={% if sort_key == 'candidate_count' and sort_order == 'desc' %}asc{% else %}desc{% endif %}">
                  {% if current_language == "ta" %}வேட்பாளர் எண்ணிக்கை{% else %}Candidates{% endif %}
                  <span class="sort-indicator{% if sort_key == 'candidate_count' %} active{% endif %}">
                    {% if sort_key == "candidate_count" %}
                      {% if sort_order == "asc" %}▲{% else %}▼{% endif %}
                    {% else %}
                      ↕
                    {% endif %}
                  </span>
                </a>
              </th>
              <th>
                <a class="link sort-link" href="?{{ base_query }}&sort=avg_cases&order={% if sort_key == 'avg_cases' and sort_order == 'desc' %}asc{% else %}desc{% endif %}">
                  {% if current_language == "ta" %}சராசரி குற்ற வழக்குகள்{% else %}Avg criminal cases{% endif %}
                  <span class="sort-indicator{% if sort_key == 'avg_cases' %} active{% endif %}">
                    {% if sort_key == "avg_cases" %}
                      {% if sort_order == "asc" %}▲{% else %}▼{% endif %}
                    {% else %}
                      ↕
                    {% endif %}
                  </span>
                </a>
              </th>
              <th>
                <a class="link sort-link" href="?{{ base_query }}&sort=cases_pct&order={% if sort_key == 'cases_pct' and sort_order == 'desc' %}asc{% else %}desc{% endif %}">
                  {% if current_language == "ta" %}குற்ற வழக்குகள் உள்ளவர்களின் விகிதம்{% else %}% w/ criminal cases{% endif %}
                  <span class="sort-indicator{% if sort_key == 'cases_pct' %} active{% endif %}">
                    {% if sort_key == "cases_pct" %}
                      {% if sort_order == "asc" %}▲{% else %}▼{% endif %}
                    {% else %}
                      ↕
                    {% endif %}
                  </span>
                </a>
              </th>
              <th>
                <a class="link sort-link" href="?{{ base_query }}&sort=avg_age&order={% if sort_key == 'avg_age' and sort_order == 'desc' %}asc{% else %}desc{% endif %}">
                  {% if current_language == "ta" %}சராசரி வயது{% else %}Avg. age{% endif %}
                  <span class="sort-indicator{% if sort_key == 'avg_age' %} active{% endif %}">
                    {% if sort_key == "avg_age" %}
                      {% if sort_order == "asc" %}▲{% else %}▼{% endif %}
                    {% else %}
                      ↕
                    {% endif %}
                  </span>
                </a>
              </th>
              <th>
                <a class="link sort-link" href="?{{ base_query }}&sort=avg_assets&order={% if sort_key == 'avg_assets' and sort_order == 'desc' %}asc{% else %}desc{% endif %}">
                  {% if current_language == "ta" %}சராசரி சொத்து (₹){% else %}Avg. assets (₹){% endif %}
                  <span class="sort-indicator{% if sort_key == 'avg_assets' %} active{% endif %}">
                    {% if sort_key == "avg_assets" %}
                      {% if sort_order == "asc" %}▲{% else %}▼{% endif %}
                    {% else %}
                      ↕
                    {% endif %}
                  </span>
                </a>
              </th>
              <th>
                <a class="link sort-link" href="?{{ base_query }}&sort=avg_liabilities&order={% if sort_key == 'avg_liabilities' and sort_order == 'desc' %}asc{% else %}desc{% endif %}">
                  {% if current_language == "ta" %}சராசரி கடன்கள் (₹){% else %}Avg. liabilities (₹){% endif %}
                  <span class="sort-indicator{% if sort_key == 'avg_liabilities' %} active{% endif %}">
                    {% if sort_key == "avg_liabilities" %}
                      {% if sort_order == "asc" %}▲{% else %}▼{% endif %}
                    {% else %}
                      ↕
                    {% endif %}
                  </span>
                </a>
              </th>
              <th>
                <a class="link sort-link" href="?{{ base_query }}&sort=top_education&order={% if sort_key == 'top_education' and sort_order == 'desc' %}asc{% else %}desc{% endif %}">
                  {% if current_language == "ta" %}அதிகம் காணப்படும் கல்வி{% else %}Most common education{% endif %}
                  <span class="sort-indicator{% if sort_key == 'top_education' %} active{% endif %}">
                    {% if sort_key == "top_education" %}
                      {% if sort_order == "asc" %}▲{% else %}▼{% endif %}
                    {% else %}
                      ↕
                    {% endif %}
                  </span>
                </a>
              </th>
            </tr>
          </thead>
          <tbody>
            {% for party in party_stats %}
            <tr>
              <td>
                <div class="party-cell">
                  {% if party.party_symbol %}
                    <img
                      class="party-symbol"
                      src="{{ party.party_symbol }}"
                      alt="{{ party.party }} symbol"
                      onerror="this.style.display='none'"
                    />
                  {% endif %}
                  <a class="link" href="/party/{{ party.party|urlencode }}/{% if base_query_no_party %}?{{ base_query_no_party }}{% endif %}">
                    {{ party.party_display|default:party.party }}
                  </a>
                </div>
              </td>
              <td>{{ party.candidate_count|indian }}</td>
              <td>{% if party.avg_cases is not None %}{{ party.avg_cases|indian }}{% else %}—{% endif %}</td>
              <td>{{ party.cases_pct|indian }}%</td>
              <td>{% if party.avg_age is not None %}{{ party.avg_age|indian }}{% else %}—{% endif %}</td>
              <td>{% if party.avg_assets is not None %}₹ {{ party.avg_assets|indian }}{% else %}—{% endif %}</td>
              <td>{% if party.avg_liabilities is not None %}₹ {{ party.avg_liabilities|indian }}{% else %}—{% endif %}</td>
              <td>{% if party.top_education %}{{ party.top_education }}{% else %}—{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>

        <!-- Card view (hidden by default, shown on mobile or via toggle) -->
        <div class="card-grid" id="card-view" style="display:none">
          {% for party in party_stats %}
          <div class="data-card"
               data-party="{{ party.party }}"
               data-candidate_count="{{ party.candidate_count }}"
               data-avg_cases="{{ party.avg_cases|default:0 }}"
               data-cases_pct="{{ party.cases_pct|default:0 }}"
               data-avg_age="{{ party.avg_age|default:0 }}"
               data-avg_assets="{{ party.avg_assets|default:0 }}"
               data-avg_liabilities="{{ party.avg_liabilities|default:0 }}"
               data-top_education="{{ party.top_education|default:"" }}">
            <div class="data-card-header">
              {% if party.party_symbol %}
                <img
                  class="party-symbol"
                  src="{{ party.party_symbol }}"
                  alt="{{ party.party }} symbol"
                  onerror="this.style.display='none'"
                />
              {% endif %}
              <a href="/party/{{ party.party|urlencode }}/{% if base_query_no_party %}?{{ base_query_no_party }}{% endif %}">
                {{ party.party_display|default:party.party }}
              </a>
            </div>
            <dl class="data-card-body">
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}வேட்பாளர்கள்{% else %}Candidates{% endif %}</dt>
                <dd>{{ party.candidate_count|indian }}</dd>
              </div>
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}சராசரி குற்ற வழக்குகள்{% else %}Avg criminal cases{% endif %}</dt>
                <dd>{% if party.avg_cases is not None %}{{ party.avg_cases|indian }}{% else %}—{% endif %}</dd>
              </div>
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}குற்ற வழக்கு %{% else %}% w/ criminal cases{% endif %}</dt>
                <dd>{{ party.cases_pct|default:"—" }}%</dd>
              </div>
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}சராசரி வயது{% else %}Avg. age{% endif %}</dt>
                <dd>{% if party.avg_age is not None %}{{ party.avg_age|indian }}{% else %}—{% endif %}</dd>
              </div>
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}சராசரி சொத்து{% else %}Avg. assets{% endif %}</dt>
                <dd>{% if party.avg_assets is not None %}₹ {{ party.avg_assets|indian }}{% else %}—{% endif %}</dd>
              </div>
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}சராசரி கடன்கள்{% else %}Avg. liabilities{% endif %}</dt>
                <dd>{% if party.avg_liabilities is not None %}₹ {{ party.avg_liabilities|indian }}{% else %}—{% endif %}</dd>
              </div>
              <div class="data-card-row">
                <dt>{% if current_language == "ta" %}அதிகம் காணப்படும் கல்வி{% else %}Most common education{% endif %}</dt>
                <dd>{% if party.top_education %}{{ party.top_education }}{% else %}—{% endif %}</dd>
              </div>
            </dl>
          </div>
          {% endfor %}
        </div>

        {% else %}
        <p class="muted">
          {% if current_language == "ta" %}
            CSV தரவுகள் கிடைக்கவில்லை.
          {% else %}
            No CSV data found.
          {% endif %}
        </p>
        {% endif %}
      </section>
    </main>
    <script>
      /* ---- Range slider sync ---- */
      document.querySelectorAll(".range-wrap").forEach((wrap) => {
        const [minInput, maxInput] = wrap.querySelectorAll("input[type='range']");
        const minOutput = wrap.querySelector(".min-value");
        const maxOutput = wrap.querySelector(".max-value");

        const format = (value) => Number(value).toLocaleString("en-IN");
        const sync = () => {
          const minValue = Math.min(Number(minInput.value), Number(maxInput.value));
          const maxValue = Math.max(Number(minInput.value), Number(maxInput.value));
          minInput.value = minValue;
          maxInput.value = maxValue;
          minOutput.textContent = format(minValue);
          maxOutput.textContent = format(maxValue);
        };

        minInput.addEventListener("input", sync);
        maxInput.addEventListener("input", sync);
        sync();
      });

      /* ---- View toggle (Table / Cards) ---- */
      (function () {
        const tableView = document.getElementById("table-view");
        const cardView = document.getElementById("card-view");
        const cardSort = document.getElementById("card-sort");
        const btns = document.querySelectorAll(".view-btn");
        if (!tableView || !cardView) return;

        function setView(mode) {
          btns.forEach((b) => b.classList.toggle("active", b.dataset.view === mode));
          tableView.style.display = mode === "table" ? "" : "none";
          cardView.style.display = mode === "cards" ? "grid" : "none";
          if (cardSort) cardSort.style.display = mode === "cards" ? "" : "none";
        }

        btns.forEach((btn) => {
          btn.addEventListener("click", () => setView(btn.dataset.view));
        });

        /* Default to cards on mobile */
        if (window.matchMedia("(max-width: 768px)").matches) {
          setView("cards");
        }
      })();

      /* ---- Card sort ---- */
      (function () {
        const select = document.getElementById("card-sort-select");
        const container = document.getElementById("card-view");
        if (!select || !container) return;

        select.addEventListener("change", function () {
          const opt = this.selectedOptions[0];
          const key = opt.value;
          const dir = opt.dataset.dir === "asc" ? 1 : -1;
          const cards = [...container.querySelectorAll(".data-card")];

          cards.sort((a, b) => {
            let va = a.dataset[key] || "";
            let vb = b.dataset[key] || "";
            const na = parseFloat(va);
            const nb = parseFloat(vb);
            if (!isNaN(na) && !isNaN(nb)) return (na - nb) * dir;
            return va.localeCompare(vb, undefined, { sensitivity: "base" }) * dir;
          });

          cards.forEach((c) => container.appendChild(c));
        });
      })();

      /* ---- Mobile filter drawer ---- */
      (function () {
        const trigger = document.getElementById("filter-trigger");
        const section = document.getElementById("filter-section");
        const backdrop = document.getElementById("filter-backdrop");
        const closeBtn = document.getElementById("filter-close");

        function openFilters() {
          section.classList.add("open");
          backdrop.classList.add("open");
          document.body.style.overflow = "hidden";
        }
        function closeFilters() {
          section.classList.remove("open");
          backdrop.classList.remove("open");
          document.body.style.overflow = "";
        }

        if (trigger) trigger.addEventListener("click", openFilters);
        if (closeBtn) closeBtn.addEventListener("click", closeFilters);
        if (backdrop) backdrop.addEventListener("click", closeFilters);

        /* Count active filters for badge */
        let count = 0;
        document.querySelectorAll("#filter-form select").forEach((s) => {
          if (s.selectedIndex > 0) count++;
        });
        document.querySelectorAll("#filter-form .range-wrap").forEach((w) => {
          const inputs = w.querySelectorAll("input[type='range']");
          if (inputs.length === 2) {
            const [mn, mx] = inputs;
            if (mn.value !== mn.min || mx.value !== mx.max) count++;
          }
        });
        const badge = document.getElementById("filter-badge");
        if (badge) badge.textContent = count || "";
      })();
    </script>
    {% include "core/_consent_dialog.html" %}
    {% include "core/_feedback_widget.html" %}
  </body>
</html>
