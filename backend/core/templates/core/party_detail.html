<!DOCTYPE html>
<html lang="en">
  {% load indian_numbers %}
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Party Details</title>
    <meta property="og:title" content="Tamil Nadu Assembly Elections 2026" />
    <meta property="og:description" content="Know your candidates and political parties, clearly and confidently. Explore financial and legal backgrounds of ~4000 candidates across 234 constituencies." />
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}/static/core/logo.png" />
    <meta property="og:type" content="website" />
    <meta name="description" content="Know your candidates and political parties, clearly and confidently. Explore financial and legal backgrounds of ~4000 candidates across 234 constituencies." />
    <link rel="stylesheet" href="/static/core/site.css" />
  </head>
  <body>
    <header class="site-header compact">
      <div class="container nav">
        <a class="brand-link" href="/">
          <div class="brand">
            <img class="brand-logo" src="/static/core/logo.png" alt="Tamil Nadu Election Tracker" />
            <div class="brand-text">
              <div class="brand-title">
                {% if current_language == "ta" %}தமிழ்நாடு தேர்தல் கண்காணிப்பான்{% else %}Tamil Nadu Election Tracker{% endif %}
              </div>
              <div class="brand-subtitle">
                {% if current_language == "ta" %}2026 சட்டமன்றத் தேர்தல்{% else %}Assembly Elections 2026{% endif %}
              </div>
            </div>
          </div>
        </a>
        <div class="nav-links">
          <a class="nav-link" href="/map/">{% if current_language == "ta" %}வரைபடம்{% else %}Maps{% endif %}</a>
          <a class="nav-link nav-link-active" href="/party-dashboard/"><span class="nav-full">{% if current_language == "ta" %}வேட்பாளர்களை அறியவும்{% else %}Know your Candidates{% endif %}</span><span class="nav-short">{% if current_language == "ta" %}வேட்பாளர்கள்{% else %}Candidates{% endif %}</span></a>
          <a class="nav-link" href="/resources/">{% if current_language == "ta" %}வளங்கள்{% else %}Resources{% endif %}</a>
        </div>
        <div class="nav-actions">
          <div class="lang-switch">
            <a class="{% if current_language == 'en' %}lang-active{% endif %}" href="/set-lang/en/?next={{ request.get_full_path|urlencode }}">English</a>
            <span class="lang-sep">•</span>
            <a class="{% if current_language == 'ta' %}lang-active{% endif %}" href="/set-lang/ta/?next={{ request.get_full_path|urlencode }}">தமிழ்</a>
          </div>
        </div>
      </div>
    </header>
    <main class="container">
      <div class="nav-row">
        <a class="link" id="back-to-dashboard" href="/party-dashboard/">← {% if current_language == "ta" %}கட்சி காட்சிப்பலகை{% else %}Party Dashboard{% endif %}</a>
        {% if data_vintage_label %}
        <div class="banner">
          {% if current_language == "ta" %}
            அதிகாரப்பூர்வ 2021 முடிவுகள். 2026 வேட்புமனு விரைவில்.
          {% else %}
            {{ data_vintage_label }}
          {% endif %}
        </div>
        {% endif %}
      </div>
      <div class="party-header">
        <h1>{{ party_display_name }}</h1>
        {% if party_symbol %}
          <img
            class="party-symbol"
            src="{{ party_symbol }}"
            alt="{{ party_display_name }} symbol"
            onerror="this.style.display='none'"
          />
        {% endif %}
      </div>
      <p class="muted">
        {% if current_language == "ta" %}
          {{ year }} ஆண்டுக்கான வேட்பாளர் பட்டியல் ({{ row_count|indian }} பதிவுகள்).
        {% else %}
          Candidate rows for {{ year }} ({{ row_count|indian }} rows).
        {% endif %}
      </p>

      {% if party_obj and party_obj.political_ideology %}
      <section class="card">
        <h2>{% if current_language == "ta" %}கட்சி விவரம்{% else %}Party Profile{% endif %}</h2>
        <div class="profile-grid">
          {% if party_obj.political_ideology %}
          <div class="profile-item">
            <span class="profile-label">{% if current_language == "ta" %}அரசியல் சித்தாந்தம்{% else %}Ideology{% endif %}</span>
            <span class="profile-value">{{ party_obj.political_ideology }}</span>
          </div>
          {% endif %}
          {% if party_obj.political_position %}
          <div class="profile-item">
            <span class="profile-label">{% if current_language == "ta" %}அரசியல் நிலை{% else %}Position{% endif %}</span>
            <span class="profile-value">{{ party_obj.political_position }}</span>
          </div>
          {% endif %}
          {% if party_obj.current_leader %}
          <div class="profile-item">
            <span class="profile-label">{% if current_language == "ta" %}தற்போதைய தலைவர்{% else %}Leader{% endif %}</span>
            <span class="profile-value">{{ party_obj.current_leader }}</span>
          </div>
          {% endif %}
          {% if party_obj.founder %}
          <div class="profile-item">
            <span class="profile-label">{% if current_language == "ta" %}நிறுவனர்{% else %}Founder{% endif %}</span>
            <span class="profile-value">{{ party_obj.founder }}</span>
          </div>
          {% endif %}
          {% if party_obj.founded_year %}
          <div class="profile-item">
            <span class="profile-label">{% if current_language == "ta" %}நிறுவப்பட்ட ஆண்டு{% else %}Founded{% endif %}</span>
            <span class="profile-value">{{ party_obj.founded_year }}</span>
          </div>
          {% endif %}
          {% if party_obj.eci_recognition %}
          <div class="profile-item">
            <span class="profile-label">{% if current_language == "ta" %}தேர்தல் ஆணையம் அங்கீகாரம்{% else %}ECI Recognition{% endif %}</span>
            <span class="profile-value">{{ party_obj.eci_recognition }}</span>
          </div>
          {% endif %}
          {% if party_obj.headquarters %}
          <div class="profile-item">
            <span class="profile-label">{% if current_language == "ta" %}தலைமையகம்{% else %}Headquarters{% endif %}</span>
            <span class="profile-value">{{ party_obj.headquarters }}</span>
          </div>
          {% endif %}
        </div>
        {% if party_obj.governance_record_note %}
        <div class="governance-note">
          <strong>{% if current_language == "ta" %}ஆட்சி பதிவு{% else %}Governance Record{% endif %}:</strong>
          {{ party_obj.governance_record_note }}
        </div>
        {% endif %}
      </section>
      {% endif %}

      <!-- Mobile filter trigger (hidden on desktop via CSS) -->
      <button class="filter-trigger" type="button" id="filter-trigger">
        {% if current_language == "ta" %}வடிகட்டிகள்{% else %}Filters{% endif %}
        <span class="filter-badge" id="filter-badge"></span>
      </button>

      <!-- Filter backdrop -->
      <div class="filter-backdrop" id="filter-backdrop"></div>

      <section class="card filter-section" id="filter-section">
        <h2>{% if current_language == "ta" %}வடிகட்டிகள்{% else %}Filters{% endif %}</h2>
        <form class="filters" method="get" id="filter-form">
          <label>
            {% if current_language == "ta" %}ஆண்டு{% else %}Year{% endif %}
            <select name="year">
              <option value="2021" {% if year == "2021" %}selected{% endif %}>2021</option>
              <option value="2026" disabled style="color: #94a3b8;">2026 ({% if current_language == "ta" %}விரைவில்{% else %}coming soon{% endif %})</option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}குற்ற வழக்குகள்{% else %}Criminal cases{% endif %}
            <select name="cases">
              <option value="" {% if not selected_cases %}selected{% endif %}>{% if current_language == "ta" %}அனைத்தும்{% else %}All{% endif %}</option>
              <option value="0" {% if selected_cases == "0" %}selected{% endif %}>{% if current_language == "ta" %}இல்லை (0){% else %}None (0){% endif %}</option>
              <option value="1-5" {% if selected_cases == "1-5" %}selected{% endif %}>1 – 5</option>
              <option value="6+" {% if selected_cases == "6+" %}selected{% endif %}>6+</option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}வயது{% else %}Age{% endif %}
            <select name="age_group">
              <option value="" {% if not selected_age_group %}selected{% endif %}>{% if current_language == "ta" %}அனைத்தும்{% else %}All{% endif %}</option>
              <option value="under35" {% if selected_age_group == "under35" %}selected{% endif %}>{% if current_language == "ta" %}35க்கு கீழ்{% else %}Under 35{% endif %}</option>
              <option value="35-44" {% if selected_age_group == "35-44" %}selected{% endif %}>35 – 44</option>
              <option value="45-54" {% if selected_age_group == "45-54" %}selected{% endif %}>45 – 54</option>
              <option value="55+" {% if selected_age_group == "55+" %}selected{% endif %}>55+</option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}சொத்துகள் (₹){% else %}Assets (₹){% endif %}
            <select name="assets_range">
              <option value="" {% if not selected_assets_range %}selected{% endif %}>{% if current_language == "ta" %}அனைத்தும்{% else %}All{% endif %}</option>
              <option value="under10l" {% if selected_assets_range == "under10l" %}selected{% endif %}>{% if current_language == "ta" %}₹10 லட்சத்திற்கு கீழ்{% else %}Under ₹10 L{% endif %}</option>
              <option value="10l-1cr" {% if selected_assets_range == "10l-1cr" %}selected{% endif %}>₹10 L – ₹1 Cr</option>
              <option value="1cr-10cr" {% if selected_assets_range == "1cr-10cr" %}selected{% endif %}>₹1 Cr – ₹10 Cr</option>
              <option value="10cr+" {% if selected_assets_range == "10cr+" %}selected{% endif %}>₹10 Cr+</option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}தற்போதைய எம்.எல்.ஏ{% else %}Sitting MLA{% endif %}
            <select name="sitting_mla">
              <option value="" {% if not sitting_mla %}selected{% endif %}>
                {% if current_language == "ta" %}எல்லாம்{% else %}All{% endif %}
              </option>
              <option value="1" {% if sitting_mla == "1" %}selected{% endif %}>
                {% if current_language == "ta" %}ஆம்{% else %}Only sitting{% endif %}
              </option>
              <option value="0" {% if sitting_mla == "0" %}selected{% endif %}>
                {% if current_language == "ta" %}இல்லை{% else %}Exclude sitting{% endif %}
              </option>
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}மாவட்டம்{% else %}District{% endif %}
            <select name="district">
              <option value="" {% if not selected_district %}selected{% endif %}>
                {% if current_language == "ta" %}அனைத்தும்{% else %}All districts{% endif %}
              </option>
              {% for district in districts %}
                <option value="{{ district }}" {% if district == selected_district %}selected{% endif %}>{{ district }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            {% if current_language == "ta" %}தொகுதி{% else %}Constituency{% endif %}
            <select name="constituency">
              <option value="" {% if not selected_constituency %}selected{% endif %}>
                {% if current_language == "ta" %}அனைத்தும்{% else %}All constituencies{% endif %}
              </option>
              {% for constituency in constituencies %}
                <option value="{{ constituency }}" {% if constituency == selected_constituency %}selected{% endif %}>{{ constituency }}</option>
              {% endfor %}
            </select>
          </label>
          <button type="submit" class="button">
            {% if current_language == "ta" %}பயன் காட்ட{% else %}Apply{% endif %}
          </button>
          <button type="button" class="btn-clear-filters" id="clear-filters">
            {% if current_language == "ta" %}அனைத்தையும் அழி{% else %}Clear all filters{% endif %}
          </button>
          <div class="filter-actions-mobile">
            <button type="submit" class="button">
              {% if current_language == "ta" %}பயன் காட்ட{% else %}Apply{% endif %}
            </button>
            <button type="button" class="btn-clear-filters" id="clear-filters-mobile">
              {% if current_language == "ta" %}அழி{% else %}Clear{% endif %}
            </button>
            <button type="button" class="filter-close-btn" id="filter-close">
              {% if current_language == "ta" %}மூடு{% else %}Close{% endif %}
            </button>
          </div>
        </form>
      </section>

      <section class="card">
        {% if rows %}

        <!-- View toggle toolbar -->
        <div class="view-toolbar">
          <div class="view-toggle">
            <button class="view-btn active" data-view="table" type="button">
              {% if current_language == "ta" %}அட்டவணை{% else %}Table{% endif %}
            </button>
            <button class="view-btn" data-view="cards" type="button">
              {% if current_language == "ta" %}அட்டைகள்{% else %}Cards{% endif %}
            </button>
          </div>
          <div class="card-sort" id="card-sort" style="display:none">
            <label>
              {% if current_language == "ta" %}வரிசைப்படுத்து{% else %}Sort by{% endif %}
              <select id="card-sort-select">
                {% for column in columns %}
                  <option value="{{ column.key }}">{{ column.label }}</option>
                {% endfor %}
              </select>
            </label>
            <button type="button" class="sort-dir-btn" id="sort-dir-btn" data-dir="desc" title="Toggle sort direction">&#9660;</button>
          </div>
        </div>

        <!-- Table view -->
        <div id="table-view">
        <table class="table">
          <thead>
            <tr>
              {% for column in columns %}
              <th>{{ column.label }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
            <tr class="{% if row.is_2016 %}is-2016{% endif %}">
              {% for column in columns %}
              {% with cell=row|get_item:column.key %}
              <td>
                {% if column.key == "candidate" and row.is_2016 %}
                  <div class="cell-with-info">
                    <span>{{ cell }}</span>
                    <button class="info-button" type="button" data-info-toggle>i</button>
                    <span class="info-popup" role="tooltip" hidden>
                      {% if current_language == "ta" %}
                        இந்த பதிவில் 2016 தகவல்கள் உள்ளன.
                      {% else %}
                        This record contains 2016 information.
                      {% endif %}
                    </span>
                  </div>
                {% elif column.key == myneta_key and cell %}
                  <a class="link" href="{{ cell }}" target="_blank" rel="noopener">Link</a>
                {% elif column.is_currency %}
                  {% if cell %}
                    <span title="₹ {{ cell|indian }}">₹ {{ cell|short_indian }}</span>
                  {% else %}
                    —
                  {% endif %}
                {% elif column.is_number %}
                  {% if cell %}
                    {{ cell|indian }}
                  {% else %}
                    —
                  {% endif %}
                {% else %}
                  {{ cell }}
                {% endif %}
              </td>
              {% endwith %}
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>

        <!-- Card view (hidden by default, shown on mobile or via toggle) -->
        <div class="card-grid" id="card-view" style="display:none">
          {% for row in rows %}
          <div class="data-card{% if row.is_2016 %} is-2016{% endif %}"
               {% for column in columns %}data-{{ column.key }}="{{ row|get_item:column.key|default:"" }}" {% endfor %}>
            <div class="data-card-header">
              {% with cand_name=row|get_item:"candidate" %}
                <span>{{ cand_name|default:"—" }}</span>
              {% endwith %}
              {% if row.is_2016 %}
                <span class="tag" style="font-size:11px; padding:2px 8px;">2016</span>
              {% endif %}
            </div>
            <dl class="data-card-body">
              {% for column in columns %}
                {% if column.key != "candidate" %}
                {% with cell=row|get_item:column.key %}
                <div class="data-card-row">
                  <dt>{{ column.label }}</dt>
                  <dd>
                    {% if column.key == myneta_key and cell %}
                      <a class="link" href="{{ cell }}" target="_blank" rel="noopener">Link</a>
                    {% elif column.is_currency %}
                      {% if cell %}<span title="₹ {{ cell|indian }}">₹ {{ cell|short_indian }}</span>{% else %}—{% endif %}
                    {% elif column.is_number %}
                      {% if cell %}{{ cell|indian }}{% else %}—{% endif %}
                    {% else %}
                      {{ cell|default:"—" }}
                    {% endif %}
                  </dd>
                </div>
                {% endwith %}
                {% endif %}
              {% endfor %}
            </dl>
          </div>
          {% endfor %}
        </div>

        {% else %}
        <p class="muted">
          {% if current_language == "ta" %}
            தரவு கிடைக்கவில்லை.
          {% else %}
            No data found.
          {% endif %}
        </p>
        {% endif %}
      </section>
    </main>
    <script>
      /* ---- Filter persistence (sessionStorage) ---- */
      (function () {
        var STORAGE_KEY = 'tntracker_filters_' + window.location.pathname;
        var navEntry = performance.getEntriesByType('navigation')[0];
        var isReload = navEntry && navEntry.type === 'reload';

        /* On reload, clear saved filters so page shows defaults */
        if (isReload) {
          sessionStorage.removeItem(STORAGE_KEY);
        }

        /* On normal navigation, if URL has no filter params, restore from storage */
        if (!isReload) {
          var params = new URLSearchParams(window.location.search);
          var hasExplicitFilters = false;
          var filterKeys = ['cases','age_group','assets_range','sitting_mla','district','constituency'];
          filterKeys.forEach(function(k) {
            if (params.get(k)) hasExplicitFilters = true;
          });

          if (!hasExplicitFilters) {
            var saved = sessionStorage.getItem(STORAGE_KEY);
            if (saved && saved !== window.location.search.substring(1)) {
              window.location.replace(window.location.pathname + '?' + saved);
              return;
            }
          }
        }

        /* Save filters on form submit */
        var form = document.getElementById('filter-form');
        if (form) {
          form.addEventListener('submit', function () {
            var fd = new FormData(form);
            var qs = new URLSearchParams(fd).toString();
            sessionStorage.setItem(STORAGE_KEY, qs);
          });
        }

        /* Save current URL params if they contain filters */
        if (window.location.search) {
          var currentParams = new URLSearchParams(window.location.search);
          var hasFilters = false;
          ['cases','age_group','assets_range','sitting_mla','district','constituency'].forEach(function(k) {
            if (currentParams.get(k)) hasFilters = true;
          });
          if (hasFilters || currentParams.get('year')) {
            sessionStorage.setItem(STORAGE_KEY, window.location.search.substring(1));
          }
        }

        /* Clear all filters button */
        function clearAllFilters() {
          sessionStorage.removeItem(STORAGE_KEY);
          window.location.href = window.location.pathname + '?year=2021';
        }
        var clearBtn = document.getElementById('clear-filters');
        var clearBtnMobile = document.getElementById('clear-filters-mobile');
        if (clearBtn) clearBtn.addEventListener('click', clearAllFilters);
        if (clearBtnMobile) clearBtnMobile.addEventListener('click', clearAllFilters);

        /* Update back-to-dashboard link to use saved dashboard filters */
        var backLink = document.getElementById('back-to-dashboard');
        if (backLink) {
          var dashKey = 'tntracker_filters_/party-dashboard/';
          var dashSaved = sessionStorage.getItem(dashKey);
          if (dashSaved) {
            backLink.href = '/party-dashboard/?' + dashSaved;
          }
        }
      })();

      /* ---- Info popup toggle ---- */
      document.querySelectorAll("[data-info-toggle]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const popup = btn.nextElementSibling;
          if (!popup) return;
          const isHidden = popup.hasAttribute("hidden");
          document.querySelectorAll(".info-popup").forEach((item) => item.setAttribute("hidden", ""));
          if (isHidden) {
            popup.removeAttribute("hidden");
          }
        });
      });
      document.addEventListener("click", (event) => {
        if (!event.target.closest(".info-button") && !event.target.closest(".info-popup")) {
          document.querySelectorAll(".info-popup").forEach((item) => item.setAttribute("hidden", ""));
        }
      });

      /* ---- View toggle (Table / Cards) ---- */
      (function () {
        const tableView = document.getElementById("table-view");
        const cardView = document.getElementById("card-view");
        const cardSort = document.getElementById("card-sort");
        const btns = document.querySelectorAll(".view-btn");
        if (!tableView || !cardView) return;

        function setView(mode) {
          btns.forEach((b) => b.classList.toggle("active", b.dataset.view === mode));
          tableView.style.display = mode === "table" ? "" : "none";
          cardView.style.display = mode === "cards" ? "grid" : "none";
          if (cardSort) cardSort.style.display = mode === "cards" ? "" : "none";
        }

        btns.forEach((btn) => {
          btn.addEventListener("click", () => setView(btn.dataset.view));
        });

        /* Default to cards on mobile */
        if (window.matchMedia("(max-width: 768px)").matches) {
          setView("cards");
        }
      })();

      /* ---- Card sort ---- */
      (function () {
        const select = document.getElementById("card-sort-select");
        const container = document.getElementById("card-view");
        const dirBtn = document.getElementById("sort-dir-btn");
        if (!select || !container || !dirBtn) return;

        function sortCards() {
          const key = select.value;
          const dir = dirBtn.dataset.dir === "asc" ? 1 : -1;
          const cards = [...container.querySelectorAll(".data-card")];

          cards.sort((a, b) => {
            let va = a.dataset[key] || "";
            let vb = b.dataset[key] || "";
            const na = parseFloat(va);
            const nb = parseFloat(vb);
            if (!isNaN(na) && !isNaN(nb)) return (na - nb) * dir;
            return va.localeCompare(vb, undefined, { sensitivity: "base" }) * dir;
          });

          cards.forEach((c) => container.appendChild(c));
        }

        select.addEventListener("change", sortCards);
        dirBtn.addEventListener("click", function () {
          const isDesc = this.dataset.dir === "desc";
          this.dataset.dir = isDesc ? "asc" : "desc";
          this.innerHTML = isDesc ? "&#9650;" : "&#9660;";
          this.title = isDesc ? "Sorted ascending" : "Sorted descending";
          sortCards();
        });
      })();

      /* ---- Mobile filter drawer ---- */
      (function () {
        const trigger = document.getElementById("filter-trigger");
        const section = document.getElementById("filter-section");
        const backdrop = document.getElementById("filter-backdrop");
        const closeBtn = document.getElementById("filter-close");

        function openFilters() {
          section.classList.add("open");
          backdrop.classList.add("open");
          document.body.style.overflow = "hidden";
        }
        function closeFilters() {
          section.classList.remove("open");
          backdrop.classList.remove("open");
          document.body.style.overflow = "";
        }

        if (trigger) trigger.addEventListener("click", openFilters);
        if (closeBtn) closeBtn.addEventListener("click", closeFilters);
        if (backdrop) backdrop.addEventListener("click", closeFilters);

        /* Count active filters for badge */
        let count = 0;
        document.querySelectorAll("#filter-form select").forEach((s) => {
          if (s.selectedIndex > 0) count++;
        });
        const badge = document.getElementById("filter-badge");
        if (badge) badge.textContent = count || "";
      })();
    </script>
    {% include "core/_footer.html" %}
    {% include "core/_consent_dialog.html" %}
    {% include "core/_feedback_widget.html" %}
  </body>
</html>
