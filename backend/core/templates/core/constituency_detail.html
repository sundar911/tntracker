<!DOCTYPE html>
<html lang="en">
  {% load indian_numbers %}
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ constituency.name }} - Candidates</title>
    <meta property="og:title" content="Tamil Nadu Assembly Elections 2026" />
    <meta property="og:description" content="Know your candidates and political parties, clearly and confidently. Explore financial and legal backgrounds of ~4000 candidates across 234 constituencies." />
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}/static/core/logo.png" />
    <meta property="og:type" content="website" />
    <meta name="description" content="Know your candidates and political parties, clearly and confidently. Explore financial and legal backgrounds of ~4000 candidates across 234 constituencies." />
    <link rel="stylesheet" href="/static/core/site.css" />
  </head>
  <body>
    <header class="site-header compact">
      <div class="container nav">
        <a class="brand-link" href="/">
          <div class="brand">
            <img class="brand-logo" src="/static/core/logo.png" alt="Tamil Nadu Election Tracker" />
            <div class="brand-text">
              <div class="brand-title">
                {% if current_language == "ta" %}தமிழ்நாடு தேர்தல் கண்காணிப்பான்{% else %}Tamil Nadu Election Tracker{% endif %}
              </div>
              <div class="brand-subtitle">
                {% if current_language == "ta" %}2026 சட்டமன்றத் தேர்தல்{% else %}Assembly Elections 2026{% endif %}
              </div>
            </div>
          </div>
        </a>
        <div class="nav-links">
          <a class="nav-link" href="/map/">{% if current_language == "ta" %}வரைபடம்{% else %}Maps{% endif %}</a>
          <a class="nav-link" href="/party-dashboard/">{% if current_language == "ta" %}வேட்பாளர்களை அறியவும்{% else %}Know your Candidates{% endif %}</a>
          <a class="nav-link" href="/resources/">{% if current_language == "ta" %}வளங்கள்{% else %}Resources{% endif %}</a>
        </div>
      </div>
    </header>
    <main class="container">
      <div class="topbar">
        <div class="lang">
          <a class="link" href="/set-lang/en/?next={{ request.get_full_path|urlencode }}">English</a>
          <span> | </span>
          <a class="link" href="/set-lang/ta/?next={{ request.get_full_path|urlencode }}">தமிழ்</a>
        </div>
      </div>
      <div class="nav-row">
        <a class="link" href="/map/">← {% if current_language == "ta" %}வரைபடம்{% else %}Back to map{% endif %}</a>
        {% if data_vintage_label %}
        <div class="banner">{{ data_vintage_label }}</div>
        {% endif %}
      </div>
      <h1>
        {% if current_language == "ta" and constituency.name_ta %}{{ constituency.name_ta }}{% else %}{{ constituency.name }}{% endif %}
      </h1>
      <p class="muted">
        {% if current_language == "ta" and constituency.district_ta %}{{ constituency.district_ta }}{% else %}{{ district_name }}{% endif %}
      </p>

      <section class="card">
        <h2>{% if current_language == "ta" %}சுருக்கம்{% else %}Summary{% endif %}</h2>
        <div class="stat-grid">
          {% for stat in summary_cards %}
          <div class="stat-card">
            <div class="stat-value">{{ stat.value }}</div>
            <div class="stat-label">{{ stat.label }}</div>
          </div>
          {% endfor %}
        </div>
      </section>

      <section class="card">
        <h2>{% if current_language == "ta" %}வேட்பாளர்கள்{% else %}Candidates{% endif %}</h2>
        <div class="sort-bar">
          <span class="sort-label">{% if current_language == "ta" %}வரிசைப்படுத்து{% else %}Sort by{% endif %}:</span>
          <button class="sort-btn" data-sort="age">{% if current_language == "ta" %}வயது{% else %}Age{% endif %}</button>
          <button class="sort-btn" data-sort="cases">{% if current_language == "ta" %}வழக்குகள்{% else %}Cases{% endif %}</button>
          <button class="sort-btn" data-sort="assets">{% if current_language == "ta" %}சொத்துகள்{% else %}Assets{% endif %}</button>
        </div>
        <div class="candidate-grid">
          {% for candidate in candidate_cards %}
          <div class="candidate-card {% if candidate.is_2016 %}is-2016{% endif %}"
               data-age="{{ candidate.age|default:'0' }}"
               data-cases="{{ candidate.criminal_cases|default:'0' }}"
               data-assets="{{ candidate.assets|default:'0' }}"
               data-sitting="{{ candidate.sitting|yesno:'1,0' }}">
            <div class="candidate-header">
              <div>
                <div class="candidate-name">{{ candidate.name }}</div>
                <div class="muted">{{ candidate.party }}</div>
              </div>
              <div class="candidate-badges">
                {% if candidate.party_symbol %}
                  <img
                    class="party-symbol"
                    src="{{ candidate.party_symbol }}"
                    alt="{{ candidate.party }} symbol"
                    loading="lazy"
                    onerror="this.style.display='none'"
                  />
                {% endif %}
                {% if candidate.is_2016 %}
                  <button class="info-button" type="button" data-info-toggle>
                    i
                  </button>
                  <span class="info-popup" role="tooltip" hidden>
                    {% if current_language == "ta" %}
                      இந்த பதிவில் 2016 தகவல்கள் உள்ளன.
                    {% else %}
                      This record contains 2016 information.
                    {% endif %}
                  </span>
                {% endif %}
                {% if candidate.sitting %}
                  <span class="tag">{% if current_language == "ta" %}தற்போதைய எம்.எல்.ஏ{% else %}Sitting MLA{% endif %}</span>
                {% endif %}
              </div>
            </div>
            <div class="candidate-meta">
              {% if candidate.education %}<span>{% if current_language == "ta" %}கல்வி{% else %}Education{% endif %}: {{ candidate.education }}</span>{% endif %}
              {% if candidate.age %}<span>{% if current_language == "ta" %}வயது{% else %}Age{% endif %}: {{ candidate.age|indian }}</span>{% endif %}
              {% if candidate.criminal_cases is not None %}<span>{% if current_language == "ta" %}வழக்குகள்{% else %}Cases{% endif %}: {{ candidate.criminal_cases|indian }}</span>{% endif %}
              <span>{% if current_language == "ta" %}சொத்துகள்{% else %}Assets{% endif %}: {% if candidate.assets %}<span title="₹ {{ candidate.assets|indian }}">₹ {{ candidate.assets|short_indian }}</span>{% else %}N/A{% endif %}</span>
              <span>{% if current_language == "ta" %}பாக்கிகள்{% else %}Liabilities{% endif %}: {% if candidate.liabilities %}<span title="₹ {{ candidate.liabilities|indian }}">₹ {{ candidate.liabilities|short_indian }}</span>{% else %}N/A{% endif %}</span>
            </div>
            {% if candidate.myneta_url %}
              <a class="link myneta-link" href="{{ candidate.myneta_url }}" target="_blank" rel="noopener">
                MyNeta Profile &rarr;
              </a>
            {% endif %}
            {% if candidate.key_promises %}
              <div class="promise-tags" aria-label="Key manifesto promises">
                {% for promise in candidate.key_promises %}
                  <span>{{ promise.text }}</span>
                {% endfor %}
              </div>
            {% endif %}
            {% if candidate.sitting and candidate.state_delivery %}
              <div class="fulfilment-block" aria-label="Promise fulfilment summary">
                <div class="fulfilment-row">
                  <strong>{% if current_language == "ta" %}மாநிலம்{% else %}State{% endif %}</strong>
                  <span class="muted">
                    {% if candidate.state_delivery.claim_percent %}
                      {% if current_language == "ta" %}கூற்று{% else %}Claim{% endif %}: {{ candidate.state_delivery.claim_percent }}
                    {% elif candidate.state_delivery.avg_score is not None %}
                      {% if current_language == "ta" %}சராசரி மதிப்பெண்{% else %}Avg score{% endif %}: {{ candidate.state_delivery.avg_score }}
                    {% else %}
                      {% if current_language == "ta" %}உறுதிப்படுத்தப்படவில்லை{% else %}Unverified{% endif %}
                    {% endif %}
                  </span>
                  {% if candidate.state_delivery.claim_url %}
                    <a class="link" href="{{ candidate.state_delivery.claim_url }}" target="_blank" rel="noopener">
                      {% if current_language == "ta" %}மூலம்{% else %}Source{% endif %}
                    </a>
                  {% endif %}
                </div>
                {% if candidate.state_delivery.summary %}
                  <div class="fulfilment-summary">{{ candidate.state_delivery.summary }}</div>
                {% endif %}
                <div class="fulfilment-row">
                  <strong>{% if current_language == "ta" %}தொகுதி{% else %}Constituency{% endif %}</strong>
                  <span class="muted">
                    {% if candidate.constituency_delivery and candidate.constituency_delivery.avg_score is not None %}
                      {% if current_language == "ta" %}சராசரி மதிப்பெண்{% else %}Avg score{% endif %}: {{ candidate.constituency_delivery.avg_score }}
                    {% elif candidate.constituency_delivery and candidate.constituency_delivery.summary %}
                      {% if current_language == "ta" %}சுருக்கம்{% else %}Summary{% endif %}
                    {% else %}
                      {% if current_language == "ta" %}உறுதிப்படுத்தப்படவில்லை{% else %}Unverified{% endif %}
                    {% endif %}
                  </span>
                </div>
                {% if candidate.constituency_delivery and candidate.constituency_delivery.summary %}
                  <div class="fulfilment-summary">{{ candidate.constituency_delivery.summary }}</div>
                {% endif %}
              </div>
            {% endif %}
          </div>
          {% empty %}
          <p>{% if current_language == "ta" %}வேட்பாளர்கள் இல்லை.{% else %}No candidates loaded yet.{% endif %}</p>
          {% endfor %}
        </div>
      </section>
    </main>
    <script>
      document.querySelectorAll("[data-info-toggle]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const popup = btn.nextElementSibling;
          if (!popup) return;
          const isHidden = popup.hasAttribute("hidden");
          document.querySelectorAll(".info-popup").forEach((item) => item.setAttribute("hidden", ""));
          if (isHidden) {
            popup.removeAttribute("hidden");
          }
        });
      });
      document.addEventListener("click", (event) => {
        if (!event.target.closest(".info-button") && !event.target.closest(".info-popup")) {
          document.querySelectorAll(".info-popup").forEach((item) => item.setAttribute("hidden", ""));
        }
      });

      /* Candidate card sorting */
      (function () {
        const grid = document.querySelector(".candidate-grid");
        if (!grid) return;
        const buttons = document.querySelectorAll(".sort-btn[data-sort]");
        let currentField = null;
        let ascending = true;

        function sortCards(field) {
          if (currentField === field) {
            ascending = !ascending;
          } else {
            currentField = field;
            ascending = field === "age";  // age: ascending first; cases/assets: descending first
          }
          buttons.forEach((b) => {
            b.classList.toggle("active", b.dataset.sort === field);
            if (b.dataset.sort === field) {
              b.textContent = b.textContent.replace(/ [▲▼]$/, "") + (ascending ? " ▲" : " ▼");
            } else {
              b.textContent = b.textContent.replace(/ [▲▼]$/, "");
            }
          });
          const cards = Array.from(grid.children).filter((el) => el.classList.contains("candidate-card"));
          cards.sort((a, b) => {
            const aSitting = a.dataset.sitting === "1";
            const bSitting = b.dataset.sitting === "1";
            if (aSitting !== bSitting) return aSitting ? -1 : 1;
            const aVal = parseFloat(a.dataset[field]) || 0;
            const bVal = parseFloat(b.dataset[field]) || 0;
            return ascending ? aVal - bVal : bVal - aVal;
          });
          cards.forEach((card) => grid.appendChild(card));
        }

        buttons.forEach((btn) => {
          btn.addEventListener("click", () => sortCards(btn.dataset.sort));
        });
      })();
    </script>
    {% include "core/_consent_dialog.html" %}
    {% include "core/_feedback_widget.html" %}
  </body>
</html>
